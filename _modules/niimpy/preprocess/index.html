

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>niimpy.preprocess &mdash; Niimpy dev documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/togglebutton.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/mystnb.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/togglebutton.js"></script>
        <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex/" />
    <link rel="search" title="Search" href="../../../search/" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../" class="icon icon-home"> Niimpy
          

          
          </a>

          
            
            
              <div class="version">
                dev
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search/" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../Introduction/">Niimpy introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Manual/">Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../schema/">Data schema</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../architecture/">Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/modules/">niimpy module index</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../">Niimpy</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../">Module code</a> &raquo;</li>
        
      <li>niimpy.preprocess</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for niimpy.preprocess</h1><div class="highlight"><pre>
<span></span><span class="c1">################################################################################</span>
<span class="c1"># This is the main file for preprocessing smartphone sensor data               #</span>
<span class="c1">#                                                                              #</span>
<span class="c1"># Contributors: Anna Hakala &amp; Ana Triana                                       #</span>
<span class="c1">################################################################################</span>

<span class="kn">import</span> <span class="nn">niimpy</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">pandas</span> <span class="kn">import</span> <span class="n">Series</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">pytz</span>
<span class="kn">import</span> <span class="nn">niimpy.aalto</span>

<div class="viewcode-block" id="get_subjects"><a class="viewcode-back" href="../../../api/niimpy.preprocess/#niimpy.preprocess.get_subjects">[docs]</a><span class="k">def</span> <span class="nf">get_subjects</span><span class="p">(</span><span class="n">database</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Returns a list of the subjects in the database</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        database: database</span>
<span class="sd">        </span>
<span class="sd">    &quot;&quot;&quot;</span> 
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">niimpy</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">Data1</span><span class="p">),</span><span class="s2">&quot;database not given in Niimpy database format&quot;</span>
    
    <span class="n">questions</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">table</span><span class="o">=</span><span class="s1">&#39;AwareHyksConverter&#39;</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">niimpy</span><span class="o">.</span><span class="n">ALL</span><span class="p">)</span>
    <span class="n">subjects</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">questions</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">subjects</span></div>

<div class="viewcode-block" id="get_phq9"><a class="viewcode-back" href="../../../api/niimpy.preprocess/#niimpy.preprocess.get_phq9">[docs]</a><span class="k">def</span> <span class="nf">get_phq9</span><span class="p">(</span><span class="n">database</span><span class="p">,</span><span class="n">subject</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Returns the phq9 scores from the databases per subject</span>
<span class="sd">    </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        database: database</span>
<span class="sd">        user: string</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    phq9: Dataframe with the phq9 score</span>
<span class="sd">        </span>
<span class="sd">    &quot;&quot;&quot;</span> 
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">niimpy</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">Data1</span><span class="p">),</span><span class="s2">&quot;database not given in Niimpy database format&quot;</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subject</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span><span class="s2">&quot;user not given in string format&quot;</span>
    
    <span class="n">phq9</span> <span class="o">=</span> <span class="n">niimpy</span><span class="o">.</span><span class="n">aalto</span><span class="o">.</span><span class="n">phq9_raw</span><span class="p">(</span><span class="n">database</span><span class="p">)</span>
    <span class="n">phq9</span> <span class="o">=</span> <span class="n">phq9</span><span class="p">[</span><span class="n">phq9</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">subject</span><span class="p">]</span>
    <span class="n">phq9</span> <span class="o">=</span> <span class="n">phq9</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;user&#39;</span><span class="p">,</span><span class="s1">&#39;source&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">phq9</span> <span class="o">=</span> <span class="n">phq9</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
    <span class="n">phq9</span> <span class="o">=</span> <span class="n">phq9</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">,</span><span class="s1">&#39;id&#39;</span><span class="p">],</span><span class="n">keep</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
    <span class="n">phq9</span> <span class="o">=</span> <span class="n">phq9</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">phq9</span><span class="o">.</span><span class="n">index</span><span class="p">)[</span><span class="s1">&#39;answer&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">phq9</span> <span class="o">=</span> <span class="n">phq9</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span>
    
    <span class="k">return</span> <span class="n">phq9</span></div>

<span class="c1">#surveys</span>
<div class="viewcode-block" id="daily_affect_variability"><a class="viewcode-back" href="../../../api/niimpy.preprocess/#niimpy.preprocess.daily_affect_variability">[docs]</a><span class="k">def</span> <span class="nf">daily_affect_variability</span><span class="p">(</span><span class="n">database</span><span class="p">,</span><span class="n">subject</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Returns two DataFrames corresponding to the daily affect variability and </span>
<span class="sd">    mean daily affect, both measures defined in the OLO paper available in </span>
<span class="sd">    10.1371/journal.pone.0110907. In brief, the mean daily affect computes the </span>
<span class="sd">    mean of each of the 7 questions (e.g. sad, cheerful, tired) asked in a </span>
<span class="sd">    likert scale from 0 to 7. Conversely, the daily affect viariability computes </span>
<span class="sd">    the standard deviation of each of the 7 questions. </span>
<span class="sd">    </span>
<span class="sd">    NOTE: This function aggregates data by day. </span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">    --------</span>
<span class="sd">    database: Niimpy database</span>
<span class="sd">    user: string</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    DLA_mean: mean of the daily affect </span>
<span class="sd">    DLA_std: standard deviation of the daily affect</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">niimpy</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">Data1</span><span class="p">),</span><span class="s2">&quot;database not given in Niimpy database format&quot;</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subject</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span><span class="s2">&quot;user not given in string format&quot;</span>

    <span class="n">questions</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">table</span><span class="o">=</span><span class="s1">&#39;AwareHyksConverter&#39;</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">subject</span><span class="p">)</span>
    <span class="n">questions</span><span class="o">=</span><span class="n">questions</span><span class="p">[(</span><span class="n">questions</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;olo_1_1&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">questions</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;olo_1_2&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">questions</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;olo_1_3&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">questions</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;olo_1_4&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">questions</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;olo_1_5&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">questions</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;olo_1_6&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">questions</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;olo_1_7&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">questions</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;olo_1_8&#39;</span><span class="p">)]</span>
    <span class="n">questions</span><span class="p">[</span><span class="s1">&#39;answer&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">questions</span><span class="p">[</span><span class="s1">&#39;answer&#39;</span><span class="p">])</span>
    <span class="n">questions</span> <span class="o">=</span> <span class="n">questions</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;device&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">tzname</span><span class="p">(</span><span class="n">questions</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span> <span class="s1">&#39;EET&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">tzname</span><span class="p">(</span><span class="n">questions</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span> <span class="s1">&#39;EEST&#39;</span><span class="p">:</span>
            <span class="n">questions</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">questions</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="s1">&#39;Europe/Helsinki&#39;</span><span class="p">)</span>
    
    <span class="n">questions</span><span class="o">=</span><span class="n">questions</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">,</span><span class="s1">&#39;id&#39;</span><span class="p">],</span><span class="n">keep</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">)</span>
    <span class="n">questions</span><span class="o">=</span><span class="n">questions</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;datetime&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s1">&#39;answer&#39;</span><span class="p">)</span>
    <span class="n">questions</span><span class="o">=</span><span class="n">questions</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;olo_1_1&#39;</span><span class="p">:</span> <span class="s1">&#39;cheerful&#39;</span><span class="p">,</span> <span class="s1">&#39;olo_1_2&#39;</span><span class="p">:</span> <span class="s1">&#39;tired&#39;</span><span class="p">,</span><span class="s1">&#39;olo_1_3&#39;</span><span class="p">:</span> <span class="s1">&#39;content&#39;</span><span class="p">,</span> <span class="s1">&#39;olo_1_4&#39;</span><span class="p">:</span> <span class="s1">&#39;nervous&#39;</span><span class="p">,</span><span class="s1">&#39;olo_1_5&#39;</span><span class="p">:</span> <span class="s1">&#39;tranquil&#39;</span><span class="p">,</span> <span class="s1">&#39;olo_1_6&#39;</span><span class="p">:</span> <span class="s1">&#39;sad&#39;</span><span class="p">,</span> <span class="s1">&#39;olo_1_7&#39;</span><span class="p">:</span> <span class="s1">&#39;excited&#39;</span><span class="p">,</span> <span class="s1">&#39;olo_1_8&#39;</span><span class="p">:</span> <span class="s1">&#39;active&#39;</span><span class="p">})</span>
    <span class="n">questions</span> <span class="o">=</span> <span class="n">questions</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    
    <span class="n">DLA</span> <span class="o">=</span> <span class="n">questions</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">questions</span><span class="p">[</span><span class="s1">&#39;date_minus_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">questions</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span> <span class="k">lambda</span> <span class="n">questions</span> <span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="n">questions</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="n">questions</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="n">questions</span><span class="o">.</span><span class="n">day</span><span class="p">))</span>
    <span class="n">questions</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">questions</span><span class="p">[</span><span class="s2">&quot;date_minus_time&quot;</span><span class="p">],</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">DLA_std</span> <span class="o">=</span> <span class="n">questions</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;D&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="c1">#), how=&#39;std&#39;)</span>
    <span class="n">DLA_std</span><span class="o">=</span><span class="n">DLA_std</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;date_minus_time&#39;</span><span class="p">:</span> <span class="s1">&#39;datetime&#39;</span><span class="p">})</span>
    <span class="n">DLA_std</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">DLA_std</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="s1">&#39;Europe/Helsinki&#39;</span><span class="p">)</span>
    
    <span class="n">DLA_mean</span> <span class="o">=</span> <span class="n">questions</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;D&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">DLA_mean</span><span class="o">=</span><span class="n">DLA_mean</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;date_minus_time&#39;</span><span class="p">:</span> <span class="s1">&#39;datetime&#39;</span><span class="p">})</span>
    <span class="n">DLA_mean</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">DLA_mean</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="s1">&#39;Europe/Helsinki&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">DLA_std</span><span class="p">,</span> <span class="n">DLA_mean</span></div>

<span class="c1">#Ambient Noise</span>
<div class="viewcode-block" id="ambient_noise"><a class="viewcode-back" href="../../../api/niimpy.preprocess/#niimpy.preprocess.ambient_noise">[docs]</a><span class="k">def</span> <span class="nf">ambient_noise</span><span class="p">(</span><span class="n">database</span><span class="p">,</span><span class="n">subject</span><span class="p">,</span><span class="n">begin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Returns a Dataframe with 5 possible computations regarding the noise</span>
<span class="sd">    ambient plug-in: average decibels, average frequency, number of times when </span>
<span class="sd">    there was noise in the day, number of times when there was a loud noise in </span>
<span class="sd">    the day (&gt;70dB), and number of times when the noise matched the speech noise</span>
<span class="sd">    level and frequency (65Hz &lt; freq &lt; 255Hz and dB&gt;50 )</span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    NOTE: This function aggregates data by day. </span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    database: Niimpy database</span>
<span class="sd">    user: string</span>
<span class="sd">    begin: datetime, optional</span>
<span class="sd">    end: datetime, optional</span>

<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    avg_noise: Dataframe</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">niimpy</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">Data1</span><span class="p">),</span><span class="s2">&quot;database not given in Niimpy database format&quot;</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subject</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span><span class="s2">&quot;user not given in string format&quot;</span>
    
    <span class="n">noise</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">table</span><span class="o">=</span><span class="s1">&#39;AwareAmbientNoise&#39;</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">subject</span><span class="p">)</span>
    
    <span class="k">if</span><span class="p">(</span><span class="n">begin</span><span class="o">!=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">begin</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">),</span><span class="s2">&quot;begin not given in timestamp format&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">begin</span> <span class="o">=</span> <span class="n">noise</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span>
    <span class="k">if</span><span class="p">(</span><span class="n">end</span><span class="o">!=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">end</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">),</span><span class="s2">&quot;end not given in timestamp format&quot;</span>  
    <span class="k">else</span><span class="p">:</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">noise</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">noise</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span>
    
    <span class="n">noise</span> <span class="o">=</span> <span class="n">noise</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;device&#39;</span><span class="p">,</span><span class="s1">&#39;user&#39;</span><span class="p">,</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;double_silence_threshold&#39;</span><span class="p">,</span><span class="s1">&#39;double_rms&#39;</span><span class="p">,</span><span class="s1">&#39;blob_raw&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">noise</span><span class="p">[</span><span class="s1">&#39;is_silent&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">noise</span><span class="p">[</span><span class="s1">&#39;is_silent&#39;</span><span class="p">])</span>
    
    <span class="n">noise</span> <span class="o">=</span> <span class="n">noise</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">begin</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>
    
    <span class="n">loud</span> <span class="o">=</span> <span class="n">noise</span><span class="p">[</span><span class="n">noise</span><span class="o">.</span><span class="n">double_decibels</span><span class="o">&gt;</span><span class="mi">70</span><span class="p">]</span> <span class="c1">#check if environment was noisy</span>
    <span class="n">speech</span> <span class="o">=</span> <span class="n">noise</span><span class="p">[</span><span class="n">noise</span><span class="p">[</span><span class="s1">&#39;double_frequency&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="mi">65</span><span class="p">,</span> <span class="mi">255</span><span class="p">)]</span>
    <span class="n">speech</span> <span class="o">=</span> <span class="n">speech</span><span class="p">[</span><span class="n">speech</span><span class="o">.</span><span class="n">is_silent</span><span class="o">==</span><span class="mi">0</span><span class="p">]</span> <span class="c1">#check if there was a conversation</span>
    <span class="n">silent</span><span class="o">=</span><span class="n">noise</span><span class="p">[</span><span class="n">noise</span><span class="o">.</span><span class="n">is_silent</span><span class="o">==</span><span class="mi">0</span><span class="p">]</span> <span class="c1">#This is more what moments there are noise in the environment. </span>
    <span class="n">avg_noise</span><span class="o">=</span><span class="n">noise</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;datetime&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="c1">#average noise</span>
    <span class="n">avg_noise</span><span class="o">=</span><span class="n">avg_noise</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;is_silent&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="n">silent</span><span class="o">=</span><span class="n">silent</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;datetime&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="n">silent</span> <span class="o">=</span> <span class="n">silent</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;double_decibels&#39;</span><span class="p">,</span><span class="s1">&#39;double_frequency&#39;</span><span class="p">,</span><span class="s1">&#39;datetime&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">silent</span><span class="o">=</span><span class="n">silent</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;is_silent&#39;</span><span class="p">:</span><span class="s1">&#39;noise&#39;</span><span class="p">})</span>
        <span class="n">avg_noise</span> <span class="o">=</span> <span class="n">avg_noise</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">silent</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">loud</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="n">loud</span><span class="o">=</span><span class="n">loud</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;datetime&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="n">loud</span> <span class="o">=</span> <span class="n">loud</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;double_decibels&#39;</span><span class="p">,</span><span class="s1">&#39;double_frequency&#39;</span><span class="p">,</span><span class="s1">&#39;datetime&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">loud</span><span class="o">=</span><span class="n">loud</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;is_silent&#39;</span><span class="p">:</span><span class="s1">&#39;loud&#39;</span><span class="p">})</span>
        <span class="n">avg_noise</span> <span class="o">=</span> <span class="n">avg_noise</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">loud</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">speech</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="n">speech</span><span class="o">=</span><span class="n">speech</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;datetime&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="n">speech</span> <span class="o">=</span> <span class="n">speech</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;double_decibels&#39;</span><span class="p">,</span><span class="s1">&#39;double_frequency&#39;</span><span class="p">,</span><span class="s1">&#39;datetime&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">speech</span><span class="o">=</span><span class="n">speech</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;is_silent&#39;</span><span class="p">:</span><span class="s1">&#39;speech&#39;</span><span class="p">})</span>
        <span class="n">avg_noise</span> <span class="o">=</span> <span class="n">avg_noise</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">speech</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">avg_noise</span></div>

<span class="c1">#Application</span>
<div class="viewcode-block" id="shutdown_info"><a class="viewcode-back" href="../../../api/niimpy.preprocess/#niimpy.preprocess.shutdown_info">[docs]</a><span class="k">def</span> <span class="nf">shutdown_info</span><span class="p">(</span><span class="n">database</span><span class="p">,</span><span class="n">subject</span><span class="p">,</span><span class="n">begin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Returns a DataFrame with the timestamps of when the phone has shutdown.</span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    NOTE: This is a helper function created originally to preprocess the application </span>
<span class="sd">    info data</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    database: Niimpy database</span>
<span class="sd">    user: string</span>
<span class="sd">    begin: datetime, optional</span>
<span class="sd">    end: datetime, optional</span>

<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    shutdown: Dataframe</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">niimpy</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">Data1</span><span class="p">),</span><span class="s2">&quot;database not given in Niimpy database format&quot;</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subject</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span><span class="s2">&quot;user not given in string format&quot;</span>
    
    <span class="n">bat</span><span class="o">=</span><span class="n">database</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">table</span><span class="o">=</span><span class="s1">&#39;AwareBattery&#39;</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">subject</span><span class="p">)</span>
    
    <span class="k">if</span><span class="p">(</span><span class="n">begin</span><span class="o">!=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">begin</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">),</span><span class="s2">&quot;begin not given in timestamp format&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">begin</span> <span class="o">=</span> <span class="n">bat</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span>
    <span class="k">if</span><span class="p">(</span><span class="n">end</span><span class="o">!=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">end</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">),</span><span class="s2">&quot;end not given in timestamp format&quot;</span>  
    <span class="k">else</span><span class="p">:</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">bat</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">bat</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span>
    
    <span class="n">bat</span> <span class="o">=</span> <span class="n">bat</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;device&#39;</span><span class="p">,</span><span class="s1">&#39;user&#39;</span><span class="p">,</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;battery_health&#39;</span><span class="p">,</span><span class="s1">&#39;battery_adaptor&#39;</span><span class="p">,</span><span class="s1">&#39;battery_level&#39;</span><span class="p">])</span>
    <span class="n">bat</span><span class="o">=</span><span class="n">bat</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">begin</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>
    <span class="n">bat</span><span class="p">[</span><span class="s1">&#39;battery_status&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">bat</span><span class="p">[</span><span class="s1">&#39;battery_status&#39;</span><span class="p">])</span>
    <span class="n">shutdown</span> <span class="o">=</span> <span class="n">bat</span><span class="p">[</span><span class="n">bat</span><span class="p">[</span><span class="s1">&#39;battery_status&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">inclusive</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">shutdown</span></div>

<div class="viewcode-block" id="screen_off"><a class="viewcode-back" href="../../../api/niimpy.preprocess/#niimpy.preprocess.screen_off">[docs]</a><span class="k">def</span> <span class="nf">screen_off</span><span class="p">(</span><span class="n">database</span><span class="p">,</span><span class="n">subject</span><span class="p">,</span><span class="n">begin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Returns a DataFrame with the timestamps of when the screen has changed </span>
<span class="sd">    to &quot;OFF&quot; status.</span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    NOTE: This is a helper function created originally to preprocess the application </span>
<span class="sd">    info data</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    database: Niimpy database</span>
<span class="sd">    user: string</span>
<span class="sd">    begin: datetime, optional</span>
<span class="sd">    end: datetime, optional</span>

<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    screen: Dataframe</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">niimpy</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">Data1</span><span class="p">),</span><span class="s2">&quot;database not given in Niimpy database format&quot;</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subject</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span><span class="s2">&quot;user not given in string format&quot;</span>
    
    <span class="n">screen</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">table</span><span class="o">=</span><span class="s1">&#39;AwareScreen&#39;</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">subject</span><span class="p">)</span>
    
    <span class="k">if</span><span class="p">(</span><span class="n">begin</span><span class="o">!=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">begin</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">),</span><span class="s2">&quot;begin not given in timestamp format&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">begin</span> <span class="o">=</span> <span class="n">screen</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span>
    <span class="k">if</span><span class="p">(</span><span class="n">end</span><span class="o">!=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">end</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">),</span><span class="s2">&quot;end not given in timestamp format&quot;</span>  
    <span class="k">else</span><span class="p">:</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">screen</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">screen</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span>
               
               
    <span class="n">screen</span><span class="o">=</span><span class="n">screen</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">],</span><span class="n">keep</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">)</span>
    <span class="n">screen</span> <span class="o">=</span> <span class="n">screen</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;device&#39;</span><span class="p">,</span><span class="s1">&#39;user&#39;</span><span class="p">,</span><span class="s1">&#39;time&#39;</span><span class="p">])</span>
    <span class="n">screen</span><span class="o">=</span><span class="n">screen</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">begin</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>
    <span class="n">screen</span><span class="p">[</span><span class="s1">&#39;screen_status&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">screen</span><span class="p">[</span><span class="s1">&#39;screen_status&#39;</span><span class="p">])</span>
    
    <span class="c1">#Include the missing points that are due to shutting down the phone</span>
    <span class="n">shutdown</span> <span class="o">=</span> <span class="n">shutdown_info</span><span class="p">(</span><span class="n">database</span><span class="p">,</span><span class="n">subject</span><span class="p">,</span><span class="n">begin</span><span class="p">,</span><span class="n">end</span><span class="p">)</span>
    <span class="n">shutdown</span><span class="o">=</span><span class="n">shutdown</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;battery_status&#39;</span><span class="p">:</span><span class="s1">&#39;screen_status&#39;</span><span class="p">})</span>
    <span class="n">shutdown</span><span class="p">[</span><span class="s1">&#39;screen_status&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">shutdown</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="n">screen</span> <span class="o">=</span> <span class="n">screen</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">shutdown</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">screen</span><span class="p">[</span><span class="s1">&#39;screen_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">screen</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="s1">&#39;screen_status_x&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">screen</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="s1">&#39;screen_status_y&#39;</span><span class="p">]</span>
        <span class="n">screen</span> <span class="o">=</span> <span class="n">screen</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;screen_status_x&#39;</span><span class="p">,</span><span class="s1">&#39;screen_status_y&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">dates</span><span class="o">=</span><span class="n">screen</span><span class="o">.</span><span class="n">datetime_x</span><span class="o">.</span><span class="n">combine_first</span><span class="p">(</span><span class="n">screen</span><span class="o">.</span><span class="n">datetime_y</span><span class="p">)</span>
        <span class="n">screen</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">dates</span>
        <span class="n">screen</span> <span class="o">=</span> <span class="n">screen</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;datetime_x&#39;</span><span class="p">,</span><span class="s1">&#39;datetime_y&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
   
    <span class="c1">#Detect missing data points</span>
    <span class="n">screen</span><span class="p">[</span><span class="s1">&#39;missing&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">screen</span><span class="p">[</span><span class="s1">&#39;next&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">screen</span><span class="p">[</span><span class="s1">&#39;screen_status&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">screen</span><span class="p">[</span><span class="s1">&#39;dummy&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">screen</span><span class="p">[</span><span class="s1">&#39;screen_status&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">screen</span><span class="p">[</span><span class="s1">&#39;next&#39;</span><span class="p">]</span>
    <span class="n">screen</span><span class="p">[</span><span class="s1">&#39;missing&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">screen</span><span class="p">[</span><span class="s1">&#39;dummy&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">screen</span><span class="p">[</span><span class="s1">&#39;missing&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">screen</span><span class="p">[</span><span class="s1">&#39;missing&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">screen</span> <span class="o">=</span> <span class="n">screen</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;dummy&#39;</span><span class="p">,</span><span class="s1">&#39;next&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">screen</span> <span class="o">=</span> <span class="n">screen</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    new = screen</span>
<span class="sd">    Previous method</span>
<span class="sd">    for i in range(len(screen)-1):</span>
<span class="sd">        if ((screen.screen_status[i]==0 and screen.screen_status[i+1]==0) or</span>
<span class="sd">            (screen.screen_status[i]==1 and screen.screen_status[i+1]==1) or </span>
<span class="sd">            (screen.screen_status[i]==2 and screen.screen_status[i+1]==2) or</span>
<span class="sd">            (screen.screen_status[i]==3 and screen.screen_status[i+1]==3)):</span>
<span class="sd">            screen.missing[i+1]=1</span>
<span class="sd">    New method tested with assert_frame_equal(new, screen, check_dtype=False)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1">#Discard missing values</span>
    <span class="n">screen</span> <span class="o">=</span> <span class="n">screen</span><span class="p">[</span><span class="n">screen</span><span class="o">.</span><span class="n">missing</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
    <span class="c1">#Select only those OFF events</span>
    <span class="n">screen</span> <span class="o">=</span> <span class="n">screen</span><span class="p">[</span><span class="n">screen</span><span class="o">.</span><span class="n">screen_status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
    <span class="k">del</span> <span class="n">screen</span><span class="p">[</span><span class="s1">&#39;missing&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">screen</span></div>

<div class="viewcode-block" id="get_seconds"><a class="viewcode-back" href="../../../api/niimpy.preprocess/#niimpy.preprocess.get_seconds">[docs]</a><span class="k">def</span> <span class="nf">get_seconds</span><span class="p">(</span><span class="n">time_delta</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Converts the timedelta to seconds</span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    NOTE: This is a helper function </span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    time_delta: Timedelta</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">return</span> <span class="n">time_delta</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">seconds</span></div>

<div class="viewcode-block" id="app_duration"><a class="viewcode-back" href="../../../api/niimpy.preprocess/#niimpy.preprocess.app_duration">[docs]</a><span class="k">def</span> <span class="nf">app_duration</span><span class="p">(</span><span class="n">database</span><span class="p">,</span><span class="n">subject</span><span class="p">,</span><span class="n">begin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">app_list_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Returns two DataFrames contanining the duration and number of events per</span>
<span class="sd">    group of apps, e.g. number of times a person used communication apps like </span>
<span class="sd">    WhatsApp, Telegram, Messenger, sms, etc. and for how long these apps were </span>
<span class="sd">    used in a day (in seconds). </span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    database: Niimpy database</span>
<span class="sd">    user: string</span>
<span class="sd">    begin: datetime, optional</span>
<span class="sd">    end: datetime, optional</span>
<span class="sd">    app_list_path: path to the csv file where the apps are classified into groups</span>

<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    duration: Dataframe</span>
<span class="sd">    count: Dataframe</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">niimpy</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">Data1</span><span class="p">),</span><span class="s2">&quot;database not given in Niimpy database format&quot;</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subject</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span><span class="s2">&quot;user not given in string format&quot;</span>
    
    <span class="n">app</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">table</span><span class="o">=</span><span class="s1">&#39;AwareApplicationNotifications&#39;</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">subject</span><span class="p">)</span>
    
    <span class="k">if</span><span class="p">(</span><span class="n">begin</span><span class="o">!=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">begin</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">),</span><span class="s2">&quot;begin not given in timestamp format&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">begin</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span>
    <span class="k">if</span><span class="p">(</span><span class="n">end</span><span class="o">!=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">end</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">),</span><span class="s2">&quot;end not given in timestamp format&quot;</span>  
    <span class="k">else</span><span class="p">:</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">app</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span>
    <span class="k">if</span><span class="p">(</span><span class="n">app_list_path</span><span class="o">==</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">app_list_path</span> <span class="o">=</span> <span class="s1">&#39;/m/cs/scratch/networks-nima/ana/niima-code/Datastreams/Phone/apps_group.csv&#39;</span>
    
    
    <span class="n">app</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;device&#39;</span><span class="p">,</span><span class="s1">&#39;user&#39;</span><span class="p">,</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;defaults&#39;</span><span class="p">,</span><span class="s1">&#39;sound&#39;</span><span class="p">,</span><span class="s1">&#39;vibrate&#39;</span><span class="p">])</span>
    <span class="n">app</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">begin</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>
    
    <span class="c1">#Classify the apps into groups</span>
    <span class="n">app_list</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">app_list_path</span><span class="p">)</span> 
    <span class="n">app</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">app</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">group</span><span class="o">=</span><span class="n">app_list</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;application_name&#39;</span><span class="p">]])</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
        <span class="n">group</span><span class="o">=</span><span class="n">group</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
            <span class="n">app</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span><span class="s1">&#39;group&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">10</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">app</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span><span class="s1">&#39;group&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">group</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">group</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="c1">#Insert missing data due to phone being shut down</span>
    <span class="n">shutdown</span> <span class="o">=</span> <span class="n">shutdown_info</span><span class="p">(</span><span class="n">database</span><span class="p">,</span><span class="n">subject</span><span class="p">,</span><span class="n">begin</span><span class="p">,</span><span class="n">end</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">shutdown</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="n">shutdown</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">11</span>
        <span class="n">shutdown</span><span class="p">[</span><span class="s1">&#39;battery_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;off&#39;</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">shutdown</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">app</span><span class="p">[</span><span class="s1">&#39;application_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">app</span><span class="p">[</span><span class="s1">&#39;application_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="s1">&#39;off&#39;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">app</span><span class="p">[</span><span class="s1">&#39;group_x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">app</span><span class="p">[</span><span class="s1">&#39;group_x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;battery_status&#39;</span><span class="p">,</span><span class="s1">&#39;group_y&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">dates</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">datetime_x</span><span class="o">.</span><span class="n">combine_first</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">datetime_y</span><span class="p">)</span>
        <span class="n">app</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">dates</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;datetime_x&#39;</span><span class="p">,</span><span class="s1">&#39;datetime_y&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">app</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;group_x&#39;</span><span class="p">:</span><span class="s1">&#39;group&#39;</span><span class="p">})</span>
    
    <span class="c1">#Insert missing data due to the screen being off</span>
    <span class="n">screen</span><span class="o">=</span><span class="n">screen_off</span><span class="p">(</span><span class="n">database</span><span class="p">,</span><span class="n">subject</span><span class="p">,</span><span class="n">begin</span><span class="p">,</span><span class="n">end</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">screen</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">screen</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">app</span><span class="p">[</span><span class="s1">&#39;application_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">app</span><span class="p">[</span><span class="s1">&#39;application_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="s1">&#39;off&#39;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">app</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">app</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">app</span><span class="p">[</span><span class="s1">&#39;screen_status&#39;</span><span class="p">]</span>
        <span class="n">dates</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">datetime_x</span><span class="o">.</span><span class="n">combine_first</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">datetime_y</span><span class="p">)</span>
        <span class="n">app</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">dates</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;datetime_x&#39;</span><span class="p">,</span><span class="s1">&#39;datetime_y&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="c1">#Insert missing data caught by sms but unknown cause</span>
    <span class="n">sms</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">table</span><span class="o">=</span><span class="s1">&#39;AwareMessages&#39;</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">subject</span><span class="p">)</span>
    <span class="n">sms</span> <span class="o">=</span> <span class="n">sms</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;device&#39;</span><span class="p">,</span><span class="s1">&#39;user&#39;</span><span class="p">,</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;trace&#39;</span><span class="p">])</span>
    <span class="n">sms</span> <span class="o">=</span> <span class="n">sms</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">,</span><span class="s1">&#39;message_type&#39;</span><span class="p">],</span><span class="n">keep</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">)</span>
    <span class="n">sms</span> <span class="o">=</span> <span class="n">sms</span><span class="p">[</span><span class="n">sms</span><span class="o">.</span><span class="n">message_type</span><span class="o">==</span><span class="s1">&#39;outgoing&#39;</span><span class="p">]</span>
    <span class="n">sms</span> <span class="o">=</span> <span class="n">sms</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">begin</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">sms</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">sms</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">app</span><span class="p">[</span><span class="s1">&#39;application_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">app</span><span class="p">[</span><span class="s1">&#39;application_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="s1">&#39;sms&#39;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">app</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">app</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">app</span><span class="p">[</span><span class="s1">&#39;message_type&#39;</span><span class="p">]</span>
        <span class="n">dates</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">datetime_x</span><span class="o">.</span><span class="n">combine_first</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">datetime_y</span><span class="p">)</span>
        <span class="n">app</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">dates</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;datetime_x&#39;</span><span class="p">,</span><span class="s1">&#39;datetime_y&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
   
    <span class="c1">#Insert missing data caught by calls but unknown cause</span>
    <span class="n">call</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">table</span><span class="o">=</span><span class="s1">&#39;AwareCalls&#39;</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">subject</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">call</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="n">call</span> <span class="o">=</span> <span class="n">call</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;device&#39;</span><span class="p">,</span><span class="s1">&#39;user&#39;</span><span class="p">,</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;trace&#39;</span><span class="p">])</span>
        <span class="n">call</span> <span class="o">=</span> <span class="n">call</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">,</span><span class="s1">&#39;call_type&#39;</span><span class="p">],</span><span class="n">keep</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">)</span>
        <span class="n">call</span><span class="p">[</span><span class="s1">&#39;call_duration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="n">call</span><span class="o">.</span><span class="n">call_duration</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">)</span>
        <span class="n">call</span> <span class="o">=</span> <span class="n">call</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">begin</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>
        <span class="n">dummy</span> <span class="o">=</span> <span class="n">call</span><span class="o">.</span><span class="n">datetime</span><span class="o">+</span><span class="n">call</span><span class="o">.</span><span class="n">call_duration</span>
        <span class="n">dummy</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="o">.</span><span class="n">to_frame</span><span class="p">(</span><span class="n">dummy</span><span class="p">)</span>
        <span class="n">dummy</span><span class="p">[</span><span class="s1">&#39;finish&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dummy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dummy</span> <span class="o">=</span> <span class="n">dummy</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">call</span> <span class="o">=</span> <span class="n">call</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">dummy</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">dates</span><span class="o">=</span><span class="n">call</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">combine_first</span><span class="p">(</span><span class="n">call</span><span class="o">.</span><span class="n">finish</span><span class="p">)</span>
        <span class="n">call</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">dates</span>
        <span class="n">call</span> <span class="o">=</span> <span class="n">call</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;call_duration&#39;</span><span class="p">,</span><span class="s1">&#39;finish&#39;</span><span class="p">])</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">call</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">app</span><span class="o">.</span><span class="n">group</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">group</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">app</span><span class="o">.</span><span class="n">application_name</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">application_name</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;call&#39;</span><span class="p">)</span>
        <span class="n">dates</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">datetime_x</span><span class="o">.</span><span class="n">combine_first</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">datetime_y</span><span class="p">)</span>
        <span class="n">app</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">dates</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;datetime_x&#39;</span><span class="p">,</span><span class="s1">&#39;datetime_y&#39;</span><span class="p">,</span><span class="s1">&#39;call_type&#39;</span><span class="p">])</span>
    
    <span class="c1">#Calculate the app duration per group</span>
    <span class="n">app</span><span class="p">[</span><span class="s1">&#39;duration&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">app</span><span class="p">[</span><span class="s1">&#39;duration&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">app</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
    <span class="n">app</span><span class="p">[</span><span class="s1">&#39;duration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">app</span><span class="p">[</span><span class="s1">&#39;duration&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="n">app</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">app</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
    <span class="n">duration</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="n">app</span><span class="p">,</span><span class="n">values</span><span class="o">=</span><span class="s1">&#39;duration&#39;</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;datetime&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="n">aggfunc</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">)</span>
    <span class="n">count</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="n">app</span><span class="p">,</span><span class="n">values</span><span class="o">=</span><span class="s1">&#39;duration&#39;</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;datetime&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="n">aggfunc</span><span class="o">=</span><span class="s1">&#39;count&#39;</span><span class="p">)</span>
    <span class="n">duration</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">duration</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">map</span><span class="p">({</span><span class="mf">0.0</span><span class="p">:</span> <span class="s1">&#39;sports&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">:</span> <span class="s1">&#39;games&#39;</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">:</span> <span class="s1">&#39;communication&#39;</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">:</span> <span class="s1">&#39;social_media&#39;</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">:</span> <span class="s1">&#39;news&#39;</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">:</span> <span class="s1">&#39;travel&#39;</span><span class="p">,</span> <span class="mf">6.0</span><span class="p">:</span> <span class="s1">&#39;shop&#39;</span><span class="p">,</span> <span class="mf">7.0</span><span class="p">:</span> <span class="s1">&#39;entretainment&#39;</span><span class="p">,</span> <span class="mf">8.0</span><span class="p">:</span> <span class="s1">&#39;work_study&#39;</span><span class="p">,</span> <span class="mf">9.0</span><span class="p">:</span> <span class="s1">&#39;transportation&#39;</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">:</span> <span class="s1">&#39;other&#39;</span><span class="p">,</span> <span class="mf">11.0</span><span class="p">:</span> <span class="s1">&#39;off&#39;</span><span class="p">})</span>
    <span class="n">count</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">count</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">map</span><span class="p">({</span><span class="mf">0.0</span><span class="p">:</span> <span class="s1">&#39;sports&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">:</span> <span class="s1">&#39;games&#39;</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">:</span> <span class="s1">&#39;communication&#39;</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">:</span> <span class="s1">&#39;social_media&#39;</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">:</span> <span class="s1">&#39;news&#39;</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">:</span> <span class="s1">&#39;travel&#39;</span><span class="p">,</span> <span class="mf">6.0</span><span class="p">:</span> <span class="s1">&#39;shop&#39;</span><span class="p">,</span> <span class="mf">7.0</span><span class="p">:</span> <span class="s1">&#39;entretainment&#39;</span><span class="p">,</span> <span class="mf">8.0</span><span class="p">:</span> <span class="s1">&#39;work_study&#39;</span><span class="p">,</span> <span class="mf">9.0</span><span class="p">:</span> <span class="s1">&#39;transportation&#39;</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">:</span> <span class="s1">&#39;other&#39;</span><span class="p">,</span> <span class="mf">11.0</span><span class="p">:</span> <span class="s1">&#39;off&#39;</span><span class="p">})</span>
    <span class="n">duration</span> <span class="o">=</span> <span class="n">duration</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">get_seconds</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">duration</span><span class="p">,</span> <span class="n">count</span></div>

<span class="c1">#Communication</span>
<div class="viewcode-block" id="call_info"><a class="viewcode-back" href="../../../api/niimpy.preprocess/#niimpy.preprocess.call_info">[docs]</a><span class="k">def</span> <span class="nf">call_info</span><span class="p">(</span><span class="n">database</span><span class="p">,</span><span class="n">subject</span><span class="p">,</span><span class="n">begin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Returns a DataFrame contanining the duration and number of events per</span>
<span class="sd">    type of calls (outgoing, incoming, missed). The Dataframe summarizes the </span>
<span class="sd">    duration of the incoming/outgoing calls in seconds, number of those events,</span>
<span class="sd">    and how long (in seconds) the person has spoken to the top 5 contacts (most</span>
<span class="sd">    frequent)</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    database: Niimpy database</span>
<span class="sd">    user: string</span>
<span class="sd">    begin: datetime, optional</span>
<span class="sd">    end: datetime, optional</span>

<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    duration: Dataframe</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">niimpy</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">Data1</span><span class="p">),</span><span class="s2">&quot;database not given in Niimpy database format&quot;</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subject</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span><span class="s2">&quot;user not given in string format&quot;</span>
    
    <span class="n">call</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">table</span><span class="o">=</span><span class="s1">&#39;AwareCalls&#39;</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">subject</span><span class="p">)</span>
    
    <span class="k">if</span><span class="p">(</span><span class="n">begin</span><span class="o">!=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">begin</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">),</span><span class="s2">&quot;begin not given in timestamp format&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">begin</span> <span class="o">=</span> <span class="n">call</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span>
    <span class="k">if</span><span class="p">(</span><span class="n">end</span><span class="o">!=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">end</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">),</span><span class="s2">&quot;end not given in timestamp format&quot;</span>  
    <span class="k">else</span><span class="p">:</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">call</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">call</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span>
    
    <span class="n">call</span> <span class="o">=</span> <span class="n">call</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;device&#39;</span><span class="p">,</span><span class="s1">&#39;user&#39;</span><span class="p">,</span><span class="s1">&#39;time&#39;</span><span class="p">])</span>
    <span class="n">call</span> <span class="o">=</span> <span class="n">call</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">begin</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>
    <span class="n">call</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">call</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
    <span class="n">call</span><span class="p">[</span><span class="s1">&#39;call_duration&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">call</span><span class="p">[</span><span class="s1">&#39;call_duration&#39;</span><span class="p">])</span>
    <span class="n">duration</span> <span class="o">=</span> <span class="n">call</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;datetime&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    
    <span class="n">missed_calls</span> <span class="o">=</span> <span class="n">call</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">call</span><span class="p">[</span><span class="s1">&#39;call_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;missed&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;datetime&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
    <span class="n">outgoing_calls</span> <span class="o">=</span> <span class="n">call</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">call</span><span class="p">[</span><span class="s1">&#39;call_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;outgoing&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;datetime&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
    <span class="n">incoming_calls</span> <span class="o">=</span> <span class="n">call</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">call</span><span class="p">[</span><span class="s1">&#39;call_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;incoming&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;datetime&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
    <span class="n">duration</span><span class="p">[</span><span class="s1">&#39;call_missed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">missed_calls</span><span class="p">[</span><span class="s1">&#39;call_type&#39;</span><span class="p">]</span>
    <span class="n">duration</span><span class="p">[</span><span class="s1">&#39;call_outgoing&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">outgoing_calls</span><span class="p">[</span><span class="s1">&#39;call_type&#39;</span><span class="p">]</span>
    <span class="n">duration</span><span class="p">[</span><span class="s1">&#39;call_incoming&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">incoming_calls</span><span class="p">[</span><span class="s1">&#39;call_type&#39;</span><span class="p">]</span>
    <span class="n">duration2</span> <span class="o">=</span> <span class="n">call</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;datetime&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;call_type&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s1">&#39;call_duration&#39;</span><span class="p">,</span><span class="n">aggfunc</span><span class="o">=</span><span class="s1">&#39;sum&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;incoming&#39;</span> <span class="ow">in</span> <span class="n">duration2</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
        <span class="n">duration2</span> <span class="o">=</span> <span class="n">duration2</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;incoming&#39;</span><span class="p">:</span> <span class="s1">&#39;call_incoming_duration&#39;</span><span class="p">})</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;outgoing&#39;</span> <span class="ow">in</span> <span class="n">duration2</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
        <span class="n">duration2</span> <span class="o">=</span> <span class="n">duration2</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;outgoing&#39;</span><span class="p">:</span> <span class="s1">&#39;call_outgoing_duration&#39;</span><span class="p">})</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;missed&#39;</span> <span class="ow">in</span> <span class="n">duration2</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
        <span class="n">duration2</span> <span class="o">=</span> <span class="n">duration2</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;missed&#39;</span><span class="p">])</span>
    <span class="n">duration</span> <span class="o">=</span> <span class="n">duration</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">duration2</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">duration</span> <span class="o">=</span> <span class="n">duration</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;missed_y&#39;</span> <span class="ow">in</span> <span class="n">duration</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
        <span class="n">duration</span> <span class="o">=</span>  <span class="n">duration</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;missed_y&#39;</span><span class="p">])</span>
    <span class="c1">#duration.columns = [&#39;total_call_duration&#39;, &#39;call_missed&#39;, &#39;call_outgoing&#39;, &#39;call_incoming&#39;, &#39;call_incoming_duration&#39;, &#39;call_outgoing_duration&#39;]</span>
    
    <span class="c1">#Now let&#39;s calculate something more sophisticated... Let&#39;s see </span>
    <span class="n">trace</span> <span class="o">=</span> <span class="n">call</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;trace&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
    <span class="n">trace</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;call_type&#39;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">top5</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[:</span><span class="mi">5</span><span class="p">]</span>
    <span class="n">call</span><span class="p">[</span><span class="s1">&#39;frequent&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">call</span> <span class="o">=</span> <span class="n">call</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">call</span> <span class="o">=</span> <span class="n">call</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="s1">&#39;date&#39;</span><span class="p">})</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">call</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">call</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span><span class="s1">&#39;trace&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">top5</span><span class="p">):</span>
            <span class="n">call</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span><span class="s1">&#39;frequent&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
    <span class="n">call</span><span class="p">[</span><span class="s1">&#39;frequent&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">call</span><span class="p">[</span><span class="s1">&#39;frequent&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">duration2</span> <span class="o">=</span> <span class="n">call</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;call_type&#39;</span><span class="p">,</span><span class="s1">&#39;frequent&#39;</span><span class="p">],</span> <span class="n">values</span><span class="o">=</span><span class="s1">&#39;call_duration&#39;</span><span class="p">,</span><span class="n">aggfunc</span><span class="o">=</span><span class="s1">&#39;sum&#39;</span><span class="p">)</span>
    <span class="n">duration2</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">col</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">duration2</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
    <span class="n">duration2</span> <span class="o">=</span> <span class="n">duration2</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span> 
    
    <span class="c1">#duration2.columns = [&#39;datetime&#39;,&#39;incoming_0&#39;,&#39;incoming_1&#39;,&#39;missed_0&#39;,&#39;missed_1&#39;,&#39;outgoing_0&#39;,&#39;outgoing_1&#39;]</span>
    <span class="n">duration2</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">duration2</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
    <span class="n">duration2</span> <span class="o">=</span> <span class="n">duration2</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;datetime&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;incoming_0&#39;</span> <span class="ow">in</span> <span class="n">duration2</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
        <span class="n">duration2</span> <span class="o">=</span> <span class="n">duration2</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;incoming_0&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;missed_0&#39;</span> <span class="ow">in</span> <span class="n">duration2</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
        <span class="n">duration2</span> <span class="o">=</span> <span class="n">duration2</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;missed_0&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;missed_1&#39;</span> <span class="ow">in</span> <span class="n">duration2</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
        <span class="n">duration2</span> <span class="o">=</span> <span class="n">duration2</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;missed_1&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;outgoing_0&#39;</span> <span class="ow">in</span> <span class="n">duration2</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
        <span class="n">duration2</span> <span class="o">=</span> <span class="n">duration2</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;outgoing_0&#39;</span><span class="p">])</span>
    <span class="n">duration</span> <span class="o">=</span> <span class="n">duration</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">duration2</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">duration</span> <span class="o">=</span> <span class="n">duration</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;incoming_1&#39;</span><span class="p">:</span> <span class="s1">&#39;incoming_duration_top5&#39;</span><span class="p">,</span> <span class="s1">&#39;outgoing_1&#39;</span><span class="p">:</span> <span class="s1">&#39;outgoing_duration_top5&#39;</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">duration</span></div>

<div class="viewcode-block" id="sms_info"><a class="viewcode-back" href="../../../api/niimpy.preprocess/#niimpy.preprocess.sms_info">[docs]</a><span class="k">def</span> <span class="nf">sms_info</span><span class="p">(</span><span class="n">database</span><span class="p">,</span><span class="n">subject</span><span class="p">,</span><span class="n">begin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Returns a DataFrame contanining the number of events per type of messages </span>
<span class="sd">    SMS (outgoing, incoming). The Dataframe summarizes the number of the </span>
<span class="sd">    incoming/outgoing sms and how many of those correspond to the top 5 contacts </span>
<span class="sd">    (most frequent with whom the subject exchanges texts)</span>
<span class="sd">        </span>
<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    database: Niimpy database</span>
<span class="sd">    user: string</span>
<span class="sd">    begin: datetime, optional</span>
<span class="sd">    end: datetime, optional</span>

<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    sms_stats: Dataframe</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">niimpy</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">Data1</span><span class="p">),</span><span class="s2">&quot;database not given in Niimpy database format&quot;</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subject</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span><span class="s2">&quot;user not given in string format&quot;</span>
    
    <span class="n">sms</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">table</span><span class="o">=</span><span class="s1">&#39;AwareMessages&#39;</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">subject</span><span class="p">)</span>
    
    <span class="k">if</span><span class="p">(</span><span class="n">begin</span><span class="o">!=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">begin</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">),</span><span class="s2">&quot;begin not given in timestamp format&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">begin</span> <span class="o">=</span> <span class="n">sms</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span>
    <span class="k">if</span><span class="p">(</span><span class="n">end</span><span class="o">!=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">end</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">),</span><span class="s2">&quot;end not given in timestamp format&quot;</span>  
    <span class="k">else</span><span class="p">:</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">sms</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">sms</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span>
            
    
    <span class="n">sms</span> <span class="o">=</span> <span class="n">sms</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;device&#39;</span><span class="p">,</span><span class="s1">&#39;user&#39;</span><span class="p">,</span><span class="s1">&#39;time&#39;</span><span class="p">])</span>
    <span class="n">sms</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sms</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
    <span class="n">sms</span> <span class="o">=</span> <span class="n">sms</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">begin</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sms</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">sms_stats</span> <span class="o">=</span> <span class="n">sms</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">sms_stats</span><span class="p">[</span><span class="s1">&#39;dummy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">sms_stats</span> <span class="o">=</span> <span class="n">sms_stats</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;datetime&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;message_type&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s1">&#39;dummy&#39;</span><span class="p">,</span><span class="n">aggfunc</span><span class="o">=</span><span class="s1">&#39;sum&#39;</span><span class="p">)</span>
        
        <span class="c1">#Now let&#39;s move to somethign more sophisticated</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">sms</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;trace&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;message_type&#39;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">top5</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[:</span><span class="mi">5</span><span class="p">]</span>
        <span class="n">sms</span><span class="p">[</span><span class="s1">&#39;frequent&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">sms</span> <span class="o">=</span> <span class="n">sms</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">sms</span> <span class="o">=</span> <span class="n">sms</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="s1">&#39;date&#39;</span><span class="p">})</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">sms</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">sms</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span><span class="s1">&#39;trace&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">top5</span><span class="p">):</span>
                <span class="n">sms</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span><span class="s1">&#39;frequent&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
                <span class="n">sms</span><span class="p">[</span><span class="s1">&#39;frequent&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sms</span><span class="p">[</span><span class="s1">&#39;frequent&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
                <span class="n">sms</span><span class="p">[</span><span class="s1">&#39;dummy&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
        <span class="n">dummy</span> <span class="o">=</span> <span class="n">sms</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;message_type&#39;</span><span class="p">,</span><span class="s1">&#39;frequent&#39;</span><span class="p">],</span> <span class="n">values</span><span class="o">=</span><span class="s1">&#39;dummy&#39;</span><span class="p">,</span><span class="n">aggfunc</span><span class="o">=</span><span class="s1">&#39;sum&#39;</span><span class="p">)</span>
        <span class="n">dummy</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">col</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">dummy</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
        <span class="n">dummy</span> <span class="o">=</span> <span class="n">dummy</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span> 
        <span class="n">dummy</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dummy</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
        <span class="n">dummy</span> <span class="o">=</span> <span class="n">dummy</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;datetime&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;incoming_0&#39;</span> <span class="ow">in</span> <span class="n">dummy</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
            <span class="n">dummy</span> <span class="o">=</span> <span class="n">dummy</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;incoming_0&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;outgoing_0&#39;</span> <span class="ow">in</span> <span class="n">dummy</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
            <span class="n">dummy</span> <span class="o">=</span> <span class="n">dummy</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;outgoing_0&#39;</span><span class="p">])</span>
        <span class="n">sms_stats</span> <span class="o">=</span> <span class="n">sms_stats</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">dummy</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">sms_stats</span> <span class="o">=</span> <span class="n">sms_stats</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;incoming_1&#39;</span><span class="p">:</span> <span class="s1">&#39;sms_incoming_top5&#39;</span><span class="p">,</span> <span class="s1">&#39;outgoing_1&#39;</span><span class="p">:</span> <span class="s1">&#39;sms_outgoing_top5&#39;</span><span class="p">})</span>
        <span class="n">sms_stats</span> <span class="o">=</span> <span class="n">sms_stats</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;incoming&#39;</span> <span class="ow">in</span> <span class="n">sms_stats</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
            <span class="n">sms_stats</span> <span class="o">=</span> <span class="n">sms_stats</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;incoming&#39;</span><span class="p">:</span> <span class="s1">&#39;sms_incoming&#39;</span><span class="p">})</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;outgoing&#39;</span> <span class="ow">in</span> <span class="n">sms_stats</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
            <span class="n">sms_stats</span> <span class="o">=</span> <span class="n">sms_stats</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;outgoing&#39;</span><span class="p">:</span> <span class="s1">&#39;sms_outgoing&#39;</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">sms_stats</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sms_stats</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">sms_stats</span></div>

<div class="viewcode-block" id="sms_duration"><a class="viewcode-back" href="../../../api/niimpy.preprocess/#niimpy.preprocess.sms_duration">[docs]</a><span class="k">def</span> <span class="nf">sms_duration</span><span class="p">(</span><span class="n">database</span><span class="p">,</span><span class="n">subject</span><span class="p">,</span><span class="n">begin</span><span class="p">,</span><span class="n">end</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Returns a DataFrame contanining the duration per type of messages SMS </span>
<span class="sd">    (outgoing, incoming). The Dataframe summarizes the calculated duration of </span>
<span class="sd">    the incoming/outgoing sms and the lags (i.e. the period between receiving a</span>
<span class="sd">    message and reading/writing a reply).</span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    NOTE: The foundation of this function is still weak and needs discussion</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    database: Niimpy database</span>
<span class="sd">    user: string</span>
<span class="sd">    begin: datetime, optional</span>
<span class="sd">    end: datetime, optional</span>

<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    reading: Dataframe</span>
<span class="sd">    writing: Dataframe</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">niimpy</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">Data1</span><span class="p">),</span><span class="s2">&quot;database not given in Niimpy database format&quot;</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subject</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span><span class="s2">&quot;user not given in string format&quot;</span>
    
    <span class="n">app</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">table</span><span class="o">=</span><span class="s1">&#39;AwareApplicationNotifications&#39;</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">subject</span><span class="p">)</span>
    
    <span class="k">if</span><span class="p">(</span><span class="n">begin</span><span class="o">!=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">begin</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">),</span><span class="s2">&quot;begin not given in timestamp format&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">begin</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span>
    <span class="k">if</span><span class="p">(</span><span class="n">end</span><span class="o">!=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">end</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">),</span><span class="s2">&quot;end not given in timestamp format&quot;</span>  
    <span class="k">else</span><span class="p">:</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">app</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span>
    
    <span class="n">app</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;device&#39;</span><span class="p">,</span><span class="s1">&#39;user&#39;</span><span class="p">,</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;defaults&#39;</span><span class="p">,</span><span class="s1">&#39;sound&#39;</span><span class="p">,</span><span class="s1">&#39;vibrate&#39;</span><span class="p">])</span>
    
    <span class="c1">#Insert missing data due to phone being shut down</span>
    <span class="n">shutdown</span> <span class="o">=</span> <span class="n">shutdown_info</span><span class="p">(</span><span class="n">database</span><span class="p">,</span><span class="n">subject</span><span class="p">,</span><span class="n">begin</span><span class="p">,</span><span class="n">end</span><span class="p">)</span>
    <span class="n">shutdown</span><span class="o">=</span><span class="n">shutdown</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;battery_status&#39;</span><span class="p">:</span><span class="s1">&#39;application_name&#39;</span><span class="p">})</span>
    <span class="n">shutdown</span><span class="p">[</span><span class="s1">&#39;application_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;off&#39;</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">shutdown</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">app</span><span class="p">[</span><span class="s1">&#39;application_name_x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">app</span><span class="p">[</span><span class="s1">&#39;application_name_x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="s1">&#39;off&#39;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">app</span><span class="p">[</span><span class="s1">&#39;application_name_y&#39;</span><span class="p">]</span>
    <span class="n">dates</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">datetime_x</span><span class="o">.</span><span class="n">combine_first</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">datetime_y</span><span class="p">)</span>
    <span class="n">app</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">dates</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;datetime_x&#39;</span><span class="p">,</span><span class="s1">&#39;datetime_y&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">app</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;application_name_x&#39;</span><span class="p">:</span><span class="s1">&#39;application_name&#39;</span><span class="p">})</span>
    
    <span class="c1">#Insert missing data due to the screen being off</span>
    <span class="n">screen</span><span class="o">=</span><span class="n">screen_off</span><span class="p">(</span><span class="n">database</span><span class="p">,</span><span class="n">subject</span><span class="p">,</span><span class="n">begin</span><span class="p">,</span><span class="n">end</span><span class="p">)</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">screen</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">app</span><span class="p">[</span><span class="s1">&#39;application_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">app</span><span class="p">[</span><span class="s1">&#39;application_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="s1">&#39;off&#39;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">app</span><span class="p">[</span><span class="s1">&#39;screen_status&#39;</span><span class="p">]</span>
    <span class="n">dates</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">datetime_x</span><span class="o">.</span><span class="n">combine_first</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">datetime_y</span><span class="p">)</span>
    <span class="n">app</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">dates</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;datetime_x&#39;</span><span class="p">,</span><span class="s1">&#39;datetime_y&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">,</span><span class="s1">&#39;application_name&#39;</span><span class="p">],</span><span class="n">keep</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">)</span>
    
    <span class="c1">#Insert missing data caught by sms but unknown cause</span>
    <span class="n">sms</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">table</span><span class="o">=</span><span class="s1">&#39;AwareMessages&#39;</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">subject</span><span class="p">)</span>
    <span class="n">sms</span> <span class="o">=</span> <span class="n">sms</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;device&#39;</span><span class="p">,</span><span class="s1">&#39;user&#39;</span><span class="p">,</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;trace&#39;</span><span class="p">])</span>
    <span class="n">sms</span> <span class="o">=</span> <span class="n">sms</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">,</span><span class="s1">&#39;message_type&#39;</span><span class="p">],</span><span class="n">keep</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">)</span>
    <span class="c1">#sms = sms[sms.message_type==&#39;outgoing&#39;]</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">sms</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">app</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">app</span><span class="p">[</span><span class="s1">&#39;application_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">(),</span><span class="s1">&#39;application_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">app</span><span class="p">[</span><span class="s1">&#39;message_type&#39;</span><span class="p">]</span>
    <span class="k">del</span> <span class="n">app</span><span class="p">[</span><span class="s1">&#39;message_type&#39;</span><span class="p">]</span>
    <span class="n">dates</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">datetime_x</span><span class="o">.</span><span class="n">combine_first</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">datetime_y</span><span class="p">)</span>
    <span class="n">app</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">dates</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;datetime_x&#39;</span><span class="p">,</span><span class="s1">&#39;datetime_y&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="c1">#Calculate the app duration</span>
    <span class="n">app</span><span class="p">[</span><span class="s1">&#39;duration&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">app</span><span class="p">[</span><span class="s1">&#39;duration&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">app</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
    <span class="n">app</span><span class="p">[</span><span class="s1">&#39;duration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">app</span><span class="p">[</span><span class="s1">&#39;duration&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1">#Select the text applications only</span>
    <span class="n">sms_app_name</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Messages&#39;</span><span class="p">,</span><span class="s1">&#39;Mensajera&#39;</span><span class="p">,</span><span class="s1">&#39;Mensajera&#39;</span><span class="p">,</span><span class="s1">&#39;Viestit&#39;</span><span class="p">,</span><span class="s1">&#39;incoming&#39;</span><span class="p">,</span><span class="s1">&#39;outgoing&#39;</span><span class="p">]</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">app</span><span class="p">[</span><span class="n">app</span><span class="p">[</span><span class="s1">&#39;application_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">sms_app_name</span><span class="p">)]</span>
    <span class="n">sms_app_name</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Messages&#39;</span><span class="p">,</span><span class="s1">&#39;Mensajera&#39;</span><span class="p">,</span><span class="s1">&#39;Mensajera&#39;</span><span class="p">,</span><span class="s1">&#39;Viestit&#39;</span><span class="p">]</span>
    <span class="n">app</span><span class="p">[</span><span class="s1">&#39;application_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">app</span><span class="p">[</span><span class="s1">&#39;application_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">sms_app_name</span><span class="p">))]</span> <span class="o">=</span> <span class="s1">&#39;messages&#39;</span>
    <span class="n">app</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">app</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">application_name</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;incoming&#39;</span> <span class="ow">and</span> <span class="n">app</span><span class="o">.</span><span class="n">application_name</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;messages&#39;</span><span class="p">):</span>
            <span class="n">app</span><span class="o">.</span><span class="n">group</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">application_name</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;messages&#39;</span> <span class="ow">and</span> <span class="n">app</span><span class="o">.</span><span class="n">application_name</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;outgoing&#39;</span><span class="p">):</span>
            <span class="n">app</span><span class="o">.</span><span class="n">group</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">app</span><span class="o">.</span><span class="n">group</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">app</span><span class="p">[</span><span class="s1">&#39;lags&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">app</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
    <span class="n">app</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">app</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
    <span class="n">app</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">begin</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>
    <span class="n">reading</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">app</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">)]</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">reading</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">reading</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="n">reading</span><span class="p">,</span><span class="n">values</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;duration&#39;</span><span class="p">,</span><span class="s1">&#39;lags&#39;</span><span class="p">],</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;datetime&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;application_name&#39;</span><span class="p">,</span> <span class="n">aggfunc</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">)</span>
        <span class="n">reading</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;reading_duration&#39;</span><span class="p">,</span><span class="s1">&#39;reading_lags&#39;</span><span class="p">]</span>
        <span class="n">reading</span> <span class="o">=</span> <span class="n">reading</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">get_seconds</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">writing</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">app</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">2</span><span class="p">)]</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">writing</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">writing</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">writing</span><span class="o">.</span><span class="n">lags</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">seconds</span><span class="o">&lt;</span><span class="mi">15</span> <span class="ow">or</span> <span class="n">writing</span><span class="o">.</span><span class="n">lags</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">seconds</span><span class="o">&gt;</span><span class="mi">120</span><span class="p">):</span>
                <span class="n">writing</span><span class="o">.</span><span class="n">lags</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="s1">&#39;00:05&#39;</span><span class="p">,</span> <span class="s2">&quot;%M:%S&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="s2">&quot;00:00&quot;</span><span class="p">,</span> <span class="s2">&quot;%M:%S&quot;</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">writing</span><span class="p">[</span><span class="s1">&#39;duration&#39;</span><span class="p">]</span>
        <span class="n">writing</span> <span class="o">=</span> <span class="n">writing</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;lags&#39;</span><span class="p">:</span><span class="s1">&#39;writing_duration&#39;</span><span class="p">})</span>
        <span class="n">writing</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="n">writing</span><span class="p">,</span><span class="n">values</span><span class="o">=</span><span class="s1">&#39;writing_duration&#39;</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;datetime&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;application_name&#39;</span><span class="p">,</span> <span class="n">aggfunc</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">)</span>
        <span class="n">writing</span> <span class="o">=</span> <span class="n">writing</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">get_seconds</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">reading</span><span class="p">,</span> <span class="n">writing</span></div>
        
<div class="viewcode-block" id="communication_info"><a class="viewcode-back" href="../../../api/niimpy.preprocess/#niimpy.preprocess.communication_info">[docs]</a><span class="k">def</span> <span class="nf">communication_info</span><span class="p">(</span><span class="n">database</span><span class="p">,</span><span class="n">subject</span><span class="p">,</span><span class="n">begin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Returns a DataFrame contanining all the information extracted from </span>
<span class="sd">    communication&#39;s events (calls, sms, and communication apps like WhatsApp,</span>
<span class="sd">    Telegram, Messenger, etc.). Regarding calls, this function contains the </span>
<span class="sd">    duration of the incoming/outgoing calls in seconds, number of those events,</span>
<span class="sd">    and how long (in seconds) the person has spoken to the top 5 contacts (most</span>
<span class="sd">    frequent). Regarding the SMSs, this function contains the number of incoming</span>
<span class="sd">    /outgoing events, and the top 5 contacts (most frequent). Aditionally, we </span>
<span class="sd">    also include the calculated duration of the incoming/outgoing sms and the </span>
<span class="sd">    lags (i.e. the period between receiving a message and reading/writing a </span>
<span class="sd">    reply). Regarding the app, the duration of communication events is summarized. </span>
<span class="sd">    </span>
<span class="sd">    This function also sums all the different durations (calls, SMSs, apps) and </span>
<span class="sd">    provides the duration (in seconds) that a person spent communicating during</span>
<span class="sd">    the day. </span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    database: Niimpy database</span>
<span class="sd">    user: string</span>
<span class="sd">    begin: datetime, optional</span>
<span class="sd">    end: datetime, optional</span>

<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    call_summary: Dataframe</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">niimpy</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">Data1</span><span class="p">),</span><span class="s2">&quot;database not given in Niimpy database format&quot;</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subject</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span><span class="s2">&quot;user not given in string format&quot;</span>
    
    <span class="n">app</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">table</span><span class="o">=</span><span class="s1">&#39;AwareApplicationNotifications&#39;</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">subject</span><span class="p">)</span>
    
    <span class="k">if</span><span class="p">(</span><span class="n">begin</span><span class="o">!=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">begin</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">),</span><span class="s2">&quot;begin not given in timestamp format&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">begin</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span>
    <span class="k">if</span><span class="p">(</span><span class="n">end</span><span class="o">!=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">end</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">),</span><span class="s2">&quot;end not given in timestamp format&quot;</span>  
    <span class="k">else</span><span class="p">:</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">app</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span>
    
    <span class="n">duration_app</span><span class="p">,</span> <span class="n">count_app</span> <span class="o">=</span> <span class="n">app_duration</span><span class="p">(</span><span class="n">database</span><span class="p">,</span><span class="n">subject</span><span class="p">,</span><span class="n">begin</span><span class="p">,</span><span class="n">end</span><span class="p">)</span>
    <span class="n">call_summary</span> <span class="o">=</span> <span class="n">call_info</span><span class="p">(</span><span class="n">database</span><span class="p">,</span><span class="n">subject</span><span class="p">,</span><span class="n">begin</span><span class="p">,</span><span class="n">end</span><span class="p">)</span>
    <span class="n">sms_summary</span> <span class="o">=</span> <span class="n">sms_info</span><span class="p">(</span><span class="n">database</span><span class="p">,</span><span class="n">subject</span><span class="p">,</span><span class="n">begin</span><span class="p">,</span><span class="n">end</span><span class="p">)</span>
    <span class="c1">#reading, writing = sms_duration(database,subject,begin,end)</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">sms_summary</span><span class="o">.</span><span class="n">empty</span><span class="p">):</span>
        <span class="n">call_summary</span> <span class="o">=</span> <span class="n">call_summary</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">sms_summary</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">call_summary</span> <span class="o">=</span> <span class="n">call_summary</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="c1">#Now let&#39;s see if there is any info from the apps worth bringin back</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;communication&#39;</span> <span class="ow">in</span> <span class="n">duration_app</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span> <span class="c1">#2 is the number for communication apps</span>
        <span class="n">comm_app</span> <span class="o">=</span> <span class="n">duration_app</span><span class="p">[</span><span class="s1">&#39;communication&#39;</span><span class="p">]</span><span class="c1">#.dt.seconds</span>
        <span class="n">comm_app</span> <span class="o">=</span> <span class="n">comm_app</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">comm_app</span> <span class="o">=</span> <span class="n">comm_app</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;social_media&#39;</span> <span class="ow">in</span> <span class="n">duration_app</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span> <span class="c1">#2 is the number for communication apps</span>
        <span class="n">social_app</span> <span class="o">=</span> <span class="n">duration_app</span><span class="p">[</span><span class="s1">&#39;social_media&#39;</span><span class="p">]</span><span class="c1">#.dt.seconds</span>
        <span class="n">social_app</span> <span class="o">=</span> <span class="n">social_app</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">social_app</span> <span class="o">=</span> <span class="n">social_app</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">social_app</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">comm_app</span>
            <span class="n">comm_app</span> <span class="o">=</span> <span class="n">comm_app</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">social_app</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
            <span class="n">comm_app</span> <span class="o">=</span> <span class="n">social_app</span>
    <span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">comm_app</span>
        <span class="n">call_summary</span> <span class="o">=</span> <span class="n">call_summary</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">comm_app</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="n">call_summary</span> <span class="o">=</span> <span class="n">call_summary</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;communication&#39;</span> <span class="ow">in</span> <span class="n">call_summary</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
        <span class="n">call_summary</span><span class="p">[</span><span class="s1">&#39;total_comm_duration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">call_summary</span><span class="p">[</span><span class="s1">&#39;call_duration&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">call_summary</span><span class="p">[</span><span class="s1">&#39;communication&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="p">((</span><span class="s1">&#39;social_media&#39;</span> <span class="ow">in</span> <span class="n">call_summary</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;communication&#39;</span> <span class="ow">in</span> <span class="n">call_summary</span><span class="o">.</span><span class="n">columns</span><span class="p">)):</span>
        <span class="n">call_summary</span><span class="p">[</span><span class="s1">&#39;total_comm_duration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">call_summary</span><span class="p">[</span><span class="s1">&#39;call_duration&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">call_summary</span><span class="p">[</span><span class="s1">&#39;social_media&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">call_summary</span><span class="p">[</span><span class="s1">&#39;communication&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;communication&#39;</span> <span class="ow">in</span> <span class="n">call_summary</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
        <span class="n">call_summary</span><span class="o">=</span><span class="n">call_summary</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;communication&#39;</span><span class="p">:</span><span class="s1">&#39;comm_apps_duration&#39;</span><span class="p">})</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;social_media&#39;</span> <span class="ow">in</span> <span class="n">call_summary</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
        <span class="n">call_summary</span><span class="o">=</span><span class="n">call_summary</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;social_media&#39;</span><span class="p">:</span><span class="s1">&#39;social_apps_duration&#39;</span><span class="p">})</span>
    
    <span class="c1">#Now let&#39;s see if there is any info from the sms duration</span>
    <span class="sd">&#39;&#39;&#39;if (len(reading)&gt;0):</span>
<span class="sd">        reading[&#39;reading_duration&#39;] = reading[&#39;reading_duration&#39;]#.dt.seconds</span>
<span class="sd">        reading[&#39;reading_lags&#39;] = reading[&#39;reading_lags&#39;]#.dt.seconds</span>
<span class="sd">        call_summary = call_summary.merge(reading, how=&#39;outer&#39;, left_index=True, right_index=True)</span>
<span class="sd">        call_summary = call_summary.fillna(0)</span>
<span class="sd">        call_summary[&#39;total_comm_duration&#39;] = call_summary[&#39;total_comm_duration&#39;]+call_summary[&#39;reading_duration&#39;]</span>
<span class="sd">    if (len(writing)&gt;0):</span>
<span class="sd">        writing=writing.rename(columns={&#39;outgoing&#39;:&#39;writing_duration&#39;})</span>
<span class="sd">        writing[&#39;writing_duration&#39;] = writing[&#39;writing_duration&#39;]#.dt.seconds</span>
<span class="sd">        call_summary = call_summary.merge(writing, how=&#39;outer&#39;, left_index=True, right_index=True)</span>
<span class="sd">        call_summary = call_summary.fillna(0)</span>
<span class="sd">        call_summary[&#39;total_comm_duration&#39;] = call_summary[&#39;total_comm_duration&#39;]+call_summary[&#39;writing_duration&#39;]&#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">call_summary</span></div>

<span class="c1">#Occurrences</span>
<div class="viewcode-block" id="occurrence_call_sms"><a class="viewcode-back" href="../../../api/niimpy.preprocess/#niimpy.preprocess.occurrence_call_sms">[docs]</a><span class="k">def</span> <span class="nf">occurrence_call_sms</span><span class="p">(</span><span class="n">database</span><span class="p">,</span><span class="n">subject</span><span class="p">,</span><span class="n">begin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Returns a DataFrame contanining the number of events that occur in a </span>
<span class="sd">    day for call and sms. The events are binned in 12-minutes, i.e. if there is </span>
<span class="sd">    an event at 11:05 and another one at 11:45, 2 occurences happened in one </span>
<span class="sd">    hour. Then, the sum of these occurences yield the number per day. </span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    database: Niimpy database</span>
<span class="sd">    user: string</span>
<span class="sd">    begin: datetime, optional</span>
<span class="sd">    end: datetime, optional</span>

<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    event: Dataframe</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">niimpy</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">Data1</span><span class="p">),</span><span class="s2">&quot;database not given in Niimpy database format&quot;</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subject</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span><span class="s2">&quot;user not given in string format&quot;</span>
    
    <span class="n">call</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">table</span><span class="o">=</span><span class="s1">&#39;AwareCalls&#39;</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">subject</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">call</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="k">if</span><span class="p">(</span><span class="n">begin</span><span class="o">!=</span><span class="kc">None</span><span class="p">):</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">begin</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">),</span><span class="s2">&quot;begin not given in timestamp format&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">begin</span> <span class="o">=</span> <span class="n">call</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span>
        <span class="k">if</span><span class="p">(</span><span class="n">end</span><span class="o">!=</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">end</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">),</span><span class="s2">&quot;end not given in timestamp format&quot;</span>  
        <span class="k">else</span><span class="p">:</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">call</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">call</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span>   
        <span class="n">call</span> <span class="o">=</span> <span class="n">call</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;device&#39;</span><span class="p">,</span><span class="s1">&#39;user&#39;</span><span class="p">,</span><span class="s1">&#39;time&#39;</span><span class="p">])</span>
        <span class="n">call</span> <span class="o">=</span> <span class="n">call</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">begin</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>
    
    <span class="n">sms</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">table</span><span class="o">=</span><span class="s1">&#39;AwareMessages&#39;</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">subject</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">sms</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="k">if</span><span class="p">(</span><span class="n">begin</span><span class="o">!=</span><span class="kc">None</span><span class="p">):</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">begin</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">),</span><span class="s2">&quot;begin not given in timestamp format&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">begin</span> <span class="o">=</span> <span class="n">call</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span>
        <span class="k">if</span><span class="p">(</span><span class="n">end</span><span class="o">!=</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">end</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">),</span><span class="s2">&quot;end not given in timestamp format&quot;</span>  
        <span class="k">else</span><span class="p">:</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">call</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">call</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span>
        <span class="n">sms</span> <span class="o">=</span> <span class="n">sms</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;device&#39;</span><span class="p">,</span><span class="s1">&#39;user&#39;</span><span class="p">,</span><span class="s1">&#39;time&#39;</span><span class="p">])</span>
        <span class="n">sms</span> <span class="o">=</span> <span class="n">sms</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">begin</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">call</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sms</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">call_sms</span> <span class="o">=</span> <span class="n">call</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">sms</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">times</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="o">.</span><span class="n">to_series</span><span class="p">(</span><span class="n">call_sms</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">keep_tz</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">times</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="o">.</span><span class="n">to_series</span><span class="p">(</span><span class="n">call</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">keep_tz</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">sms</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">call</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">call_sms</span> <span class="o">=</span> <span class="n">sms</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">call</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">times</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="o">.</span><span class="n">to_series</span><span class="p">(</span><span class="n">call_sms</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">keep_tz</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">times</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="o">.</span><span class="n">to_series</span><span class="p">(</span><span class="n">sms</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">keep_tz</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="n">event</span><span class="o">=</span><span class="n">niimpy</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">occurrence</span><span class="p">(</span><span class="n">times</span><span class="p">)</span>
    <span class="n">event</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;day&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">event</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;hour&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">event</span></div>

<div class="viewcode-block" id="occurrence_call_sms_apps"><a class="viewcode-back" href="../../../api/niimpy.preprocess/#niimpy.preprocess.occurrence_call_sms_apps">[docs]</a><span class="k">def</span> <span class="nf">occurrence_call_sms_apps</span><span class="p">(</span><span class="n">database</span><span class="p">,</span><span class="n">subject</span><span class="p">,</span><span class="n">begin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">app_list_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">comm_app_list_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Returns a DataFrame contanining the number of events that occur in a </span>
<span class="sd">    day for calls, sms, and communication apps. The events are binned in </span>
<span class="sd">    12-minutes, i.e. if there is an event at 11:05 and another one at 11:45, 2 </span>
<span class="sd">    occurences happened in one hour. Then, the sum of these occurences yield the </span>
<span class="sd">    number per day. </span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    database: Niimpy database</span>
<span class="sd">    user: string</span>
<span class="sd">    begin: datetime, optional</span>
<span class="sd">    end: datetime, optional</span>
<span class="sd">    app_list_path: path to the file where the apps are classified into groups</span>
<span class="sd">    comm_app_list_path:path to the file where the communication apps are listed</span>

<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    event: Dataframe</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">niimpy</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">Data1</span><span class="p">),</span><span class="s2">&quot;database not given in Niimpy database format&quot;</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subject</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span><span class="s2">&quot;user not given in string format&quot;</span>
    
    <span class="n">call</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">table</span><span class="o">=</span><span class="s1">&#39;AwareCalls&#39;</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">subject</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">call</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="k">if</span><span class="p">(</span><span class="n">begin</span><span class="o">!=</span><span class="kc">None</span><span class="p">):</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">begin</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">),</span><span class="s2">&quot;begin not given in timestamp format&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">begin</span> <span class="o">=</span> <span class="n">call</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span>
        <span class="k">if</span><span class="p">(</span><span class="n">end</span><span class="o">!=</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">end</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">),</span><span class="s2">&quot;end not given in timestamp format&quot;</span>  
        <span class="k">else</span><span class="p">:</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">call</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">call</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span>   
        <span class="n">call</span> <span class="o">=</span> <span class="n">call</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;device&#39;</span><span class="p">,</span><span class="s1">&#39;user&#39;</span><span class="p">,</span><span class="s1">&#39;time&#39;</span><span class="p">])</span>
        <span class="n">call</span> <span class="o">=</span> <span class="n">call</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">begin</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>
    
    <span class="n">sms</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">table</span><span class="o">=</span><span class="s1">&#39;AwareMessages&#39;</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">subject</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">sms</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="k">if</span><span class="p">(</span><span class="n">begin</span><span class="o">!=</span><span class="kc">None</span><span class="p">):</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">begin</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">),</span><span class="s2">&quot;begin not given in timestamp format&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">begin</span> <span class="o">=</span> <span class="n">sms</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span>
        <span class="k">if</span><span class="p">(</span><span class="n">end</span><span class="o">!=</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">end</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">),</span><span class="s2">&quot;end not given in timestamp format&quot;</span>  
        <span class="k">else</span><span class="p">:</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">sms</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">sms</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span>
        <span class="n">sms</span> <span class="o">=</span> <span class="n">sms</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;device&#39;</span><span class="p">,</span><span class="s1">&#39;user&#39;</span><span class="p">,</span><span class="s1">&#39;time&#39;</span><span class="p">])</span>
        <span class="n">sms</span> <span class="o">=</span> <span class="n">sms</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">begin</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>
    
    <span class="n">app</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">table</span><span class="o">=</span><span class="s1">&#39;AwareApplicationNotifications&#39;</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">subject</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">app_list_path</span><span class="o">==</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">app_list_path</span><span class="o">=</span><span class="s1">&#39;/m/cs/scratch/networks-nima/ana/niima-code/Datastreams/Phone/apps_group.csv&#39;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">comm_app_list_path</span><span class="o">==</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">comm_app_list_path</span><span class="o">=</span><span class="s1">&#39;/m/cs/scratch/networks-nima/ana/niima-code/Datastreams/Phone/comm_apps.csv&#39;</span>
        
    <span class="k">if</span> <span class="ow">not</span> <span class="n">app</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="k">if</span><span class="p">(</span><span class="n">begin</span><span class="o">!=</span><span class="kc">None</span><span class="p">):</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">begin</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">),</span><span class="s2">&quot;begin not given in timestamp format&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">begin</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span>
        <span class="k">if</span><span class="p">(</span><span class="n">end</span><span class="o">!=</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">end</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">),</span><span class="s2">&quot;end not given in timestamp format&quot;</span>  
        <span class="k">else</span><span class="p">:</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">app</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span>   
        <span class="n">app</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;device&#39;</span><span class="p">,</span><span class="s1">&#39;user&#39;</span><span class="p">,</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;defaults&#39;</span><span class="p">,</span><span class="s1">&#39;sound&#39;</span><span class="p">,</span><span class="s1">&#39;vibrate&#39;</span><span class="p">])</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">begin</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>
    
        <span class="n">app_list</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">app_list_path</span><span class="p">)</span> 
        <span class="n">app</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">app</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">group</span><span class="o">=</span><span class="n">app_list</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;application_name&#39;</span><span class="p">]])</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
            <span class="n">group</span><span class="o">=</span><span class="n">group</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
                <span class="n">app</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span><span class="s1">&#39;group&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">10</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">app</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span><span class="s1">&#39;group&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">group</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">group</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">app</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">]</span>
    
        <span class="n">comm_app_list</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">comm_app_list_path</span><span class="p">)</span>
        <span class="n">comm_app_list</span> <span class="o">=</span> <span class="n">comm_app_list</span><span class="p">[</span><span class="s1">&#39;Communication&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">app</span><span class="p">[</span><span class="o">~</span><span class="n">app</span><span class="o">.</span><span class="n">application_name</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">comm_app_list</span><span class="p">)]</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">call</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sms</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">event</span> <span class="o">=</span> <span class="n">call</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">sms</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">event</span> <span class="o">=</span> <span class="n">call</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sms</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">event</span> <span class="o">=</span> <span class="n">sms</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">event</span><span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
            
    <span class="k">if</span> <span class="ow">not</span> <span class="n">app</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">event</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">event</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">event</span><span class="o">=</span><span class="n">app</span>
            
    <span class="k">if</span> <span class="ow">not</span> <span class="n">event</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="n">times</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="o">.</span><span class="n">to_series</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">keep_tz</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">event</span><span class="o">=</span><span class="n">niimpy</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">occurrence</span><span class="p">(</span><span class="n">times</span><span class="p">)</span>
        <span class="n">event</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;day&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">event</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;hour&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">event</span></div>

<div class="viewcode-block" id="occurrence_call_sms_social"><a class="viewcode-back" href="../../../api/niimpy.preprocess/#niimpy.preprocess.occurrence_call_sms_social">[docs]</a><span class="k">def</span> <span class="nf">occurrence_call_sms_social</span><span class="p">(</span><span class="n">database</span><span class="p">,</span><span class="n">subject</span><span class="p">,</span><span class="n">begin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">app_list_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">comm_app_list_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Returns a DataFrame contanining the number of events that occur in a </span>
<span class="sd">    day for calls, sms, and social and communication apps. The events are binned </span>
<span class="sd">    in 12-minutes, i.e. if there is an event at 11:05 and another one at 11:45, </span>
<span class="sd">    2 occurences happened in one hour. Then, the sum of these occurences yield </span>
<span class="sd">    the number per day. </span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">    --------</span>
<span class="sd">    database: Niimpy database</span>
<span class="sd">    user: string</span>
<span class="sd">    begin: datetime, optional</span>
<span class="sd">    end: datetime, optional</span>
<span class="sd">    app_list_path: path to the file where the apps are classified into groups</span>
<span class="sd">    comm_app_list_path:path to the file where the communication apps are listed</span>

<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    event: Dataframe</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">niimpy</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">Data1</span><span class="p">),</span><span class="s2">&quot;database not given in Niimpy database format&quot;</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subject</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span><span class="s2">&quot;user not given in string format&quot;</span>
    
    <span class="n">call</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">table</span><span class="o">=</span><span class="s1">&#39;AwareCalls&#39;</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">subject</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">call</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="k">if</span><span class="p">(</span><span class="n">begin</span><span class="o">!=</span><span class="kc">None</span><span class="p">):</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">begin</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">),</span><span class="s2">&quot;begin not given in timestamp format&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">begin</span> <span class="o">=</span> <span class="n">call</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span>
        <span class="k">if</span><span class="p">(</span><span class="n">end</span><span class="o">!=</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">end</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">),</span><span class="s2">&quot;end not given in timestamp format&quot;</span>  
        <span class="k">else</span><span class="p">:</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">call</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">call</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span>   
        <span class="n">call</span> <span class="o">=</span> <span class="n">call</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;device&#39;</span><span class="p">,</span><span class="s1">&#39;user&#39;</span><span class="p">,</span><span class="s1">&#39;time&#39;</span><span class="p">])</span>
        <span class="n">call</span> <span class="o">=</span> <span class="n">call</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">begin</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>
    
    <span class="n">sms</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">table</span><span class="o">=</span><span class="s1">&#39;AwareMessages&#39;</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">subject</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">sms</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="k">if</span><span class="p">(</span><span class="n">begin</span><span class="o">!=</span><span class="kc">None</span><span class="p">):</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">begin</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">),</span><span class="s2">&quot;begin not given in timestamp format&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">begin</span> <span class="o">=</span> <span class="n">sms</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span>
        <span class="k">if</span><span class="p">(</span><span class="n">end</span><span class="o">!=</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">end</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">),</span><span class="s2">&quot;end not given in timestamp format&quot;</span>  
        <span class="k">else</span><span class="p">:</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">sms</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">sms</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span>
        <span class="n">sms</span> <span class="o">=</span> <span class="n">sms</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;device&#39;</span><span class="p">,</span><span class="s1">&#39;user&#39;</span><span class="p">,</span><span class="s1">&#39;time&#39;</span><span class="p">])</span>
        <span class="n">sms</span> <span class="o">=</span> <span class="n">sms</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">begin</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>
    
    <span class="n">app</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">table</span><span class="o">=</span><span class="s1">&#39;AwareApplicationNotifications&#39;</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">subject</span><span class="p">)</span>
    <span class="k">if</span><span class="p">(</span><span class="n">app_list_path</span><span class="o">==</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">app_list_path</span><span class="o">=</span><span class="s1">&#39;/m/cs/scratch/networks-nima/ana/niima-code/Datastreams/Phone/apps_group.csv&#39;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">comm_app_list_path</span><span class="o">==</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">comm_app_list_path</span><span class="o">=</span><span class="s1">&#39;/m/cs/scratch/networks-nima/ana/niima-code/Datastreams/Phone/comm_apps.csv&#39;</span>
        
    <span class="k">if</span> <span class="ow">not</span> <span class="n">app</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="k">if</span><span class="p">(</span><span class="n">begin</span><span class="o">!=</span><span class="kc">None</span><span class="p">):</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">begin</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">),</span><span class="s2">&quot;begin not given in timestamp format&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">begin</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span>
        <span class="k">if</span><span class="p">(</span><span class="n">end</span><span class="o">!=</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">end</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">),</span><span class="s2">&quot;end not given in timestamp format&quot;</span>  
        <span class="k">else</span><span class="p">:</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">app</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span> 
                
        <span class="n">app</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;device&#39;</span><span class="p">,</span><span class="s1">&#39;user&#39;</span><span class="p">,</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;defaults&#39;</span><span class="p">,</span><span class="s1">&#39;sound&#39;</span><span class="p">,</span><span class="s1">&#39;vibrate&#39;</span><span class="p">])</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">begin</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>
        <span class="n">app_list</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">app_list_path</span><span class="p">)</span> 
        <span class="n">app</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">app</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">group</span><span class="o">=</span><span class="n">app_list</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;application_name&#39;</span><span class="p">]])</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
            <span class="n">group</span><span class="o">=</span><span class="n">group</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
                <span class="n">app</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span><span class="s1">&#39;group&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">10</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">app</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span><span class="s1">&#39;group&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">group</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">group</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">app</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">app</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)]</span>
        <span class="n">comm_app_list</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">comm_app_list_path</span><span class="p">)</span>
        <span class="n">comm_app_list</span> <span class="o">=</span> <span class="n">comm_app_list</span><span class="p">[</span><span class="s1">&#39;Communication&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">app</span><span class="p">[</span><span class="o">~</span><span class="n">app</span><span class="o">.</span><span class="n">application_name</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">comm_app_list</span><span class="p">)]</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">call</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sms</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">event</span> <span class="o">=</span> <span class="n">call</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">sms</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">event</span> <span class="o">=</span> <span class="n">call</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sms</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">event</span> <span class="o">=</span> <span class="n">sms</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">event</span><span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        
    <span class="k">if</span> <span class="ow">not</span> <span class="n">app</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">event</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">event</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">event</span><span class="o">=</span><span class="n">app</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">event</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="n">times</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="o">.</span><span class="n">to_series</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">keep_tz</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">event</span><span class="o">=</span><span class="n">niimpy</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">occurrence</span><span class="p">(</span><span class="n">times</span><span class="p">)</span>
        <span class="n">event</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;day&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">event</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;hour&#39;</span><span class="p">])</span>
        <span class="n">event</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="s1">&#39;Europe/Helsinki&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">event</span></div>
    
<span class="c1">#Location</span>
<div class="viewcode-block" id="location_data"><a class="viewcode-back" href="../../../api/niimpy.preprocess/#niimpy.preprocess.location_data">[docs]</a><span class="k">def</span> <span class="nf">location_data</span><span class="p">(</span><span class="n">database</span><span class="p">,</span><span class="n">subject</span><span class="p">,</span><span class="n">begin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Reads the readily, preprocessed location data from the right database. </span>
<span class="sd">    The data already contains the aggregation of the GPS data (more info here:</span>
<span class="sd">    https://github.com/CxAalto/koota-server/blob/master/kdata/converter.py). </span>
<span class="sd">        </span>
<span class="sd">    Parameters:</span>
<span class="sd">    --------</span>
<span class="sd">    database: Niimpy database</span>
<span class="sd">    user: string</span>
<span class="sd">    begin: datetime, optional</span>
<span class="sd">    end: datetime, optional</span>

<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    location: Dataframe</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">niimpy</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">Data1</span><span class="p">),</span><span class="s2">&quot;database not given in Niimpy database format&quot;</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subject</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span><span class="s2">&quot;user not given in string format&quot;</span>
    
    <span class="n">location</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">table</span><span class="o">=</span><span class="s1">&#39;AwareLocationDay&#39;</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">subject</span><span class="p">)</span>           
    <span class="n">location</span> <span class="o">=</span> <span class="n">location</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;device&#39;</span><span class="p">,</span><span class="s1">&#39;user&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">location</span><span class="o">=</span><span class="n">location</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;day&#39;</span><span class="p">],</span><span class="n">keep</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">)</span>
    <span class="n">location</span><span class="p">[</span><span class="s1">&#39;day&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">location</span><span class="p">[</span><span class="s1">&#39;day&#39;</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">location</span><span class="o">=</span><span class="n">location</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;day&#39;</span><span class="p">)</span>
    <span class="n">location</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">location</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="s1">&#39;Europe/Helsinki&#39;</span><span class="p">)</span>
    
    <span class="k">if</span><span class="p">(</span><span class="n">begin</span><span class="o">!=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">begin</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">),</span><span class="s2">&quot;begin not given in timestamp format&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">begin</span> <span class="o">=</span> <span class="n">location</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span><span class="p">(</span><span class="n">end</span><span class="o">!=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">end</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">),</span><span class="s2">&quot;end not given in timestamp format&quot;</span>  
    <span class="k">else</span><span class="p">:</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">location</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        
    <span class="n">location</span><span class="o">=</span><span class="n">location</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">begin</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">location</span></div>

<span class="c1">#Screen</span>
<div class="viewcode-block" id="screen_duration"><a class="viewcode-back" href="../../../api/niimpy.preprocess/#niimpy.preprocess.screen_duration">[docs]</a><span class="k">def</span> <span class="nf">screen_duration</span><span class="p">(</span><span class="n">database</span><span class="p">,</span><span class="n">subject</span><span class="p">,</span><span class="n">begin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Returns two DataFrames contanining the duration and number of events for</span>
<span class="sd">    the screen transitions (ON to OFF, OFF to ON, OFF to IN USE, IRRELEVANT </span>
<span class="sd">    transitions). E.g. duration (in seconds) of the phone being ON during a day, </span>
<span class="sd">    or number of times the screen was on during the day. </span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">    --------</span>
<span class="sd">    database: Niimpy database</span>
<span class="sd">    user: string</span>
<span class="sd">    begin: datetime, optional</span>
<span class="sd">    end: datetime, optional</span>

<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    duration: Dataframe</span>
<span class="sd">    count: Dataframe</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">niimpy</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">Data1</span><span class="p">),</span><span class="s2">&quot;database not given in Niimpy database format&quot;</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subject</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span><span class="s2">&quot;usr not given in string format&quot;</span>
    
    <span class="n">screen</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">table</span><span class="o">=</span><span class="s1">&#39;AwareScreen&#39;</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">subject</span><span class="p">)</span>
    
    <span class="k">if</span><span class="p">(</span><span class="n">begin</span><span class="o">!=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">begin</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">),</span><span class="s2">&quot;begin not given in timestamp format&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">begin</span> <span class="o">=</span> <span class="n">screen</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span>
    <span class="k">if</span><span class="p">(</span><span class="n">end</span><span class="o">!=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">end</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">),</span><span class="s2">&quot;end not given in timestamp format&quot;</span>  
    <span class="k">else</span><span class="p">:</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">screen</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">screen</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span>  
        
    <span class="n">screen</span><span class="o">=</span><span class="n">screen</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">],</span><span class="n">keep</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">)</span>
    <span class="n">screen</span> <span class="o">=</span> <span class="n">screen</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;device&#39;</span><span class="p">,</span><span class="s1">&#39;user&#39;</span><span class="p">,</span><span class="s1">&#39;time&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">screen</span><span class="o">=</span><span class="n">screen</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">begin</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>
    <span class="n">screen</span><span class="p">[</span><span class="s1">&#39;screen_status&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">screen</span><span class="p">[</span><span class="s1">&#39;screen_status&#39;</span><span class="p">])</span>
    
    <span class="c1">#Include the missing points that are due to shutting down the phone</span>
    <span class="n">shutdown</span> <span class="o">=</span> <span class="n">shutdown_info</span><span class="p">(</span><span class="n">database</span><span class="p">,</span><span class="n">subject</span><span class="p">,</span><span class="n">begin</span><span class="p">,</span><span class="n">end</span><span class="p">)</span>
    <span class="n">shutdown</span><span class="o">=</span><span class="n">shutdown</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;battery_status&#39;</span><span class="p">:</span><span class="s1">&#39;screen_status&#39;</span><span class="p">})</span>
    <span class="n">shutdown</span><span class="p">[</span><span class="s1">&#39;screen_status&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">screen</span> <span class="o">=</span> <span class="n">screen</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">shutdown</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">screen</span><span class="p">[</span><span class="s1">&#39;screen_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">screen</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="s1">&#39;screen_status_x&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">screen</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="s1">&#39;screen_status_y&#39;</span><span class="p">]</span>
    <span class="n">screen</span> <span class="o">=</span> <span class="n">screen</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;screen_status_x&#39;</span><span class="p">,</span><span class="s1">&#39;screen_status_y&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">dates</span><span class="o">=</span><span class="n">screen</span><span class="o">.</span><span class="n">datetime_x</span><span class="o">.</span><span class="n">combine_first</span><span class="p">(</span><span class="n">screen</span><span class="o">.</span><span class="n">datetime_y</span><span class="p">)</span>
    <span class="n">screen</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">dates</span>
    <span class="n">screen</span> <span class="o">=</span> <span class="n">screen</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;datetime_x&#39;</span><span class="p">,</span><span class="s1">&#39;datetime_y&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="c1">#Detect missing data points</span>
    <span class="n">screen</span><span class="p">[</span><span class="s1">&#39;missing&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">screen</span><span class="p">[</span><span class="s1">&#39;next&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">screen</span><span class="p">[</span><span class="s1">&#39;screen_status&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">screen</span><span class="p">[</span><span class="s1">&#39;dummy&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">screen</span><span class="p">[</span><span class="s1">&#39;screen_status&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">screen</span><span class="p">[</span><span class="s1">&#39;next&#39;</span><span class="p">]</span>
    <span class="n">screen</span><span class="p">[</span><span class="s1">&#39;missing&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">screen</span><span class="p">[</span><span class="s1">&#39;dummy&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">screen</span><span class="p">[</span><span class="s1">&#39;missing&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">screen</span><span class="p">[</span><span class="s1">&#39;missing&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">screen</span> <span class="o">=</span> <span class="n">screen</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;dummy&#39;</span><span class="p">,</span><span class="s1">&#39;next&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">screen</span> <span class="o">=</span> <span class="n">screen</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Previous code, updated for more efficient one</span>
<span class="sd">    Verified with assert_frame_equal(screen, screen_for, check_dtype=False)</span>
<span class="sd">    screen[&#39;missing&#39;]=0</span>
<span class="sd">    for i in range(len(screen)-1):</span>
<span class="sd">        if ((screen.screen_status[i]==0 and screen.screen_status[i+1]==0) or</span>
<span class="sd">            (screen.screen_status[i]==1 and screen.screen_status[i+1]==1) or </span>
<span class="sd">            (screen.screen_status[i]==2 and screen.screen_status[i+1]==2) or</span>
<span class="sd">            (screen.screen_status[i]==3 and screen.screen_status[i+1]==3)):</span>
<span class="sd">            screen.missing[i+1]=1&#39;&#39;&#39;</span>
    
    <span class="c1">#Exclude missing datapoints, but keep track of how many were excluded first</span>
    <span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="ow">in</span> <span class="n">screen</span><span class="p">[</span><span class="s1">&#39;missing&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()):</span>
        <span class="n">missing_count</span><span class="o">=</span><span class="p">(</span><span class="n">screen</span><span class="p">[</span><span class="s1">&#39;missing&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">screen</span><span class="p">[</span><span class="s1">&#39;missing&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="mi">100</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Missing datapoints (%): &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">missing_count</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No missing values&#39;</span><span class="p">)</span>
    
    <span class="c1">#Discard missing values</span>
    <span class="n">screen</span> <span class="o">=</span> <span class="n">screen</span><span class="p">[</span><span class="n">screen</span><span class="o">.</span><span class="n">missing</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
    
    <span class="c1">#Calculate the duration</span>
    <span class="n">screen</span><span class="p">[</span><span class="s1">&#39;duration&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">screen</span><span class="p">[</span><span class="s1">&#39;duration&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">screen</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
    <span class="n">screen</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">screen</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
    <span class="n">screen</span><span class="p">[</span><span class="s1">&#39;duration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">screen</span><span class="p">[</span><span class="s1">&#39;duration&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="c1">#Classify the event </span>
    <span class="n">screen</span><span class="o">=</span><span class="n">screen</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;missing&#39;</span><span class="p">:</span><span class="s1">&#39;group&#39;</span><span class="p">})</span>
    <span class="n">screen</span><span class="p">[</span><span class="s1">&#39;next&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">screen</span><span class="p">[</span><span class="s1">&#39;screen_status&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">screen</span><span class="p">[</span><span class="s1">&#39;next&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">screen</span><span class="p">[</span><span class="s1">&#39;screen_status&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">+</span><span class="n">screen</span><span class="p">[</span><span class="s1">&#39;screen_status&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>   
    <span class="n">screen</span><span class="o">.</span><span class="n">group</span><span class="p">[(</span><span class="n">screen</span><span class="o">.</span><span class="n">next</span><span class="o">==</span><span class="s1">&#39;01&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">screen</span><span class="o">.</span><span class="n">next</span><span class="o">==</span><span class="s1">&#39;02&#39;</span><span class="p">)]</span><span class="o">=</span><span class="mi">1</span>
    <span class="n">screen</span><span class="o">.</span><span class="n">group</span><span class="p">[(</span><span class="n">screen</span><span class="o">.</span><span class="n">next</span><span class="o">==</span><span class="s1">&#39;03&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">screen</span><span class="o">.</span><span class="n">next</span><span class="o">==</span><span class="s1">&#39;13&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">screen</span><span class="o">.</span><span class="n">next</span><span class="o">==</span><span class="s1">&#39;23&#39;</span><span class="p">)]</span><span class="o">=</span><span class="mi">2</span>
    <span class="n">screen</span><span class="o">.</span><span class="n">group</span><span class="p">[(</span><span class="n">screen</span><span class="o">.</span><span class="n">next</span><span class="o">==</span><span class="s1">&#39;12&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">screen</span><span class="o">.</span><span class="n">next</span><span class="o">==</span><span class="s1">&#39;21&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">screen</span><span class="o">.</span><span class="n">next</span><span class="o">==</span><span class="s1">&#39;31&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">screen</span><span class="o">.</span><span class="n">next</span><span class="o">==</span><span class="s1">&#39;32&#39;</span><span class="p">)]</span><span class="o">=</span><span class="mi">3</span>
    <span class="k">del</span> <span class="n">screen</span><span class="p">[</span><span class="s1">&#39;next&#39;</span><span class="p">]</span>
    <span class="n">screen</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">screen</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">screen</span><span class="o">.</span><span class="n">loc</span><span class="p">[:</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;group&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">del</span> <span class="n">screen</span><span class="p">[</span><span class="s1">&#39;screen_status&#39;</span><span class="p">]</span>
    
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Older method. Previous code, updated for more efficient one</span>
<span class="sd">    Verified with assert_frame_equal(screen, screen_for, check_dtype=False)</span>
<span class="sd">    screen=screen.rename(columns={&#39;missing&#39;:&#39;group&#39;})</span>
<span class="sd">    for i in range(len(screen)-1):</span>
<span class="sd">        if ((screen.screen_status[i]==0 and screen.screen_status[i+1]==1) or</span>
<span class="sd">            (screen.screen_status[i]==0 and screen.screen_status[i+1]==2)):</span>
<span class="sd">            screen.group[i+1]=1</span>
<span class="sd">        elif ((screen.screen_status[i]==0 and screen.screen_status[i+1]==3) or</span>
<span class="sd">            (screen.screen_status[i]==1 and screen.screen_status[i+1]==3) or </span>
<span class="sd">            (screen.screen_status[i]==2 and screen.screen_status[i+1]==3)):</span>
<span class="sd">            screen.group[i+1]=2</span>
<span class="sd">        elif ((screen.screen_status[i]==1 and screen.screen_status[i+1]==2) or</span>
<span class="sd">            (screen.screen_status[i]==2 and screen.screen_status[i+1]==1) or </span>
<span class="sd">            (screen.screen_status[i]==3 and screen.screen_status[i+1]==1) or </span>
<span class="sd">            (screen.screen_status[i]==3 and screen.screen_status[i+1]==2)):</span>
<span class="sd">            screen.group[i+1]=3</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="c1">#Discard the first and last row because they do not have all info. We do not</span>
    <span class="c1">#know what happened before or after these points. </span>
    <span class="n">screen</span> <span class="o">=</span> <span class="n">screen</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="n">screen</span> <span class="o">=</span> <span class="n">screen</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="c1">#Discard any datapoints whose duration in ON and IRRELEVANT states are </span>
    <span class="c1">#longer than 2 hours</span>
    <span class="n">thr</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="s1">&#39;2 hours&#39;</span><span class="p">)</span>
    <span class="n">screen</span> <span class="o">=</span> <span class="n">screen</span><span class="p">[</span><span class="o">~</span><span class="p">((</span><span class="n">screen</span><span class="o">.</span><span class="n">group</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">screen</span><span class="o">.</span><span class="n">duration</span><span class="o">&gt;</span><span class="n">thr</span><span class="p">))]</span>
    
    <span class="c1">#Finally organize everything</span>
    <span class="n">duration</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="n">screen</span><span class="p">,</span><span class="n">values</span><span class="o">=</span><span class="s1">&#39;duration&#39;</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;datetime&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="n">aggfunc</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">)</span>
    <span class="c1">#duration[&#39;total&#39;]=duration.sum(axis=1)</span>
    <span class="c1">#mean_hours=duration[&#39;total&#39;].mean()</span>
    <span class="c1">#print(&#39;mean hours in record per day: &#39; + str(mean_hours))</span>
    <span class="n">duration</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">duration</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">map</span><span class="p">({</span><span class="mf">0.0</span><span class="p">:</span> <span class="s1">&#39;off&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">:</span> <span class="s1">&#39;on&#39;</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">:</span> <span class="s1">&#39;use&#39;</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">:</span> <span class="s1">&#39;irrelevant&#39;</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">:</span> <span class="s1">&#39;total&#39;</span><span class="p">})</span>
    <span class="n">duration</span> <span class="o">=</span> <span class="n">duration</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">get_seconds</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">count</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="n">screen</span><span class="p">,</span><span class="n">values</span><span class="o">=</span><span class="s1">&#39;duration&#39;</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;datetime&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="n">aggfunc</span><span class="o">=</span><span class="s1">&#39;count&#39;</span><span class="p">)</span>
    <span class="n">count</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">count</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">map</span><span class="p">({</span><span class="mf">0.0</span><span class="p">:</span> <span class="s1">&#39;off_count&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">:</span> <span class="s1">&#39;on_count&#39;</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">:</span> <span class="s1">&#39;use_count&#39;</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">:</span> <span class="s1">&#39;irrelevant_count&#39;</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">:</span> <span class="s1">&#39;total_count&#39;</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">duration</span><span class="p">,</span> <span class="n">count</span></div>

<div class="viewcode-block" id="get_battery_data"><a class="viewcode-back" href="../../../api/niimpy.preprocess/#niimpy.preprocess.get_battery_data">[docs]</a><span class="k">def</span> <span class="nf">get_battery_data</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">start</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Returns a DataFrame with battery data for a user.</span>
<span class="sd">    Parameters:</span>
<span class="sd">    --------</span>
<span class="sd">    database: Niimpy database</span>
<span class="sd">    user: string</span>
<span class="sd">    start: datetime, optional</span>
<span class="sd">    end: datetime, optional</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">niimpy</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">Data1</span><span class="p">),</span><span class="s2">&quot;database not given in Niimpy database format&quot;</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span><span class="s2">&quot;user not given in string format&quot;</span>

    <span class="n">battery_data</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">table</span><span class="o">=</span><span class="s1">&#39;AwareBattery&#39;</span><span class="p">,</span><span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">)</span>

    <span class="k">if</span><span class="p">(</span><span class="n">start</span><span class="o">!=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">battery_data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span>
    <span class="k">if</span><span class="p">(</span><span class="n">end</span><span class="o">!=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">end</span><span class="p">)</span>     
    <span class="k">else</span><span class="p">:</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">battery_data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">battery_data</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span>

    <span class="n">battery_data</span> <span class="o">=</span> <span class="n">battery_data</span><span class="p">[(</span><span class="n">battery_data</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span><span class="o">&gt;=</span><span class="n">start</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">battery_data</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span><span class="o">&lt;=</span><span class="n">end</span><span class="p">)]</span>    
        
    <span class="n">battery_data</span><span class="p">[</span><span class="s1">&#39;battery_level&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">battery_data</span><span class="p">[</span><span class="s1">&#39;battery_level&#39;</span><span class="p">])</span>
	
    <span class="c1">#df[&#39;column&#39;].fillna(pd.Timedelta(seconds=0))</span>
    <span class="c1">#df.dropna()</span>

    <span class="n">battery_data</span> <span class="o">=</span> <span class="n">battery_data</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">,</span><span class="s1">&#39;user&#39;</span><span class="p">,</span><span class="s1">&#39;device&#39;</span><span class="p">],</span><span class="n">keep</span><span class="o">=</span><span class="s1">&#39;last&#39;</span><span class="p">)</span>
    <span class="n">battery_data</span> <span class="o">=</span> <span class="n">battery_data</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;user&#39;</span><span class="p">,</span><span class="s1">&#39;device&#39;</span><span class="p">,</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;datetime&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">battery_data</span></div>


<div class="viewcode-block" id="battery_occurrences"><a class="viewcode-back" href="../../../api/niimpy.preprocess/#niimpy.preprocess.battery_occurrences">[docs]</a><span class="k">def</span> <span class="nf">battery_occurrences</span><span class="p">(</span><span class="n">battery_data</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">battery_status</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">days</span><span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">hours</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">minutes</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">seconds</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">milli</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">micro</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nano</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Returns a dataframe showing the amount of battery data points found between a given interval and steps.</span>
<span class="sd">        The default interval is 6 hours.</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        battery_data: Dataframe</span>
<span class="sd">	user: string, optional</span>
<span class="sd">        start: datetime, optional</span>
<span class="sd">        end: datetime, optional</span>
<span class="sd">	battery_status: boolean, optional</span>
<span class="sd">        </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">battery_data</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">),</span> <span class="s2">&quot;data is not a pandas DataFrame&quot;</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="nb">str</span><span class="p">)),</span><span class="s2">&quot;user not given in string format&quot;</span>

    <span class="k">if</span><span class="p">(</span><span class="n">user</span><span class="o">!=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">ocurrence_data</span> <span class="o">=</span> <span class="n">battery_data</span><span class="p">[(</span><span class="n">battery_data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">user</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">occurrence_data</span> <span class="o">=</span> <span class="n">battery_data</span>
    
    <span class="n">occurrence_data</span> <span class="o">=</span> <span class="n">occurrence_data</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">,</span><span class="s1">&#39;device&#39;</span><span class="p">],</span><span class="n">keep</span><span class="o">=</span><span class="s1">&#39;last&#39;</span><span class="p">)</span>
    
    <span class="k">if</span><span class="p">(</span><span class="n">start</span><span class="o">==</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">occurrence_data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>

    <span class="n">td</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">days</span><span class="p">,</span><span class="n">hours</span><span class="o">=</span><span class="n">hours</span><span class="p">,</span><span class="n">minutes</span><span class="o">=</span><span class="n">minutes</span><span class="p">,</span><span class="n">seconds</span><span class="o">=</span><span class="n">seconds</span><span class="p">,</span><span class="n">milliseconds</span><span class="o">=</span><span class="n">milli</span><span class="p">,</span><span class="n">microseconds</span><span class="o">=</span><span class="n">micro</span><span class="p">,</span><span class="n">nanoseconds</span><span class="o">=</span><span class="n">nano</span><span class="p">)</span>
    
    <span class="n">delta</span> <span class="o">=</span> <span class="n">start</span><span class="o">+</span><span class="n">td</span>
    
    <span class="k">if</span><span class="p">(</span><span class="n">end</span><span class="o">==</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">occurrence_data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">occurrence_data</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">end</span><span class="p">)</span>
    
    <span class="n">idx_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">((</span><span class="n">end</span><span class="o">-</span><span class="n">start</span><span class="p">)</span><span class="o">/</span><span class="n">td</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">periods</span> <span class="o">=</span> <span class="n">idx_range</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="n">td</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">battery_status</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="s1">&#39;battery_status&#39;</span> <span class="ow">in</span> <span class="n">occurrence_data</span><span class="o">.</span><span class="n">columns</span><span class="p">)):</span>
        <span class="n">occurrences</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">idx</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="nb">list</span><span class="p">([</span><span class="s1">&#39;start&#39;</span><span class="p">,</span><span class="s1">&#39;end&#39;</span><span class="p">,</span><span class="s1">&#39;occurrences&#39;</span><span class="p">,</span><span class="s1">&#39;battery_status&#39;</span><span class="p">]))</span>      
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">idx_range</span><span class="p">):</span>
            <span class="n">idx_dat</span> <span class="o">=</span> <span class="n">occurrence_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">occurrence_data</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="n">start</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">occurrence_data</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span><span class="o">&lt;=</span><span class="n">delta</span><span class="p">)]</span>
            <span class="n">battery_status</span> <span class="o">=</span> <span class="n">occurrence_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">occurrence_data</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="n">start</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">occurrence_data</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span><span class="o">&lt;=</span><span class="n">delta</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">((</span><span class="n">occurrence_data</span><span class="p">[</span><span class="s1">&#39;battery_status&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;-1&#39;</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="n">occurrence_data</span><span class="p">[</span><span class="s1">&#39;battery_status&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;-2&#39;</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="n">occurrence_data</span><span class="p">[</span><span class="s1">&#39;battery_status&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;-3&#39;</span><span class="p">))]</span>
            <span class="n">occurrences</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">start</span><span class="p">,</span> <span class="n">delta</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">idx_dat</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">battery_status</span><span class="p">)]</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">td</span>
            <span class="n">delta</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">td</span>
       
        
    <span class="k">else</span><span class="p">:</span>
        <span class="n">occurrences</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">idx</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="nb">list</span><span class="p">([</span><span class="s1">&#39;start&#39;</span><span class="p">,</span><span class="s1">&#39;end&#39;</span><span class="p">,</span><span class="s1">&#39;occurrences&#39;</span><span class="p">]))</span>        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">idx_range</span><span class="p">):</span>
            <span class="n">idx_dat</span> <span class="o">=</span> <span class="n">occurrence_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">occurrence_data</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="n">start</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">occurrence_data</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span><span class="o">&lt;=</span><span class="n">delta</span><span class="p">)]</span>
            <span class="n">occurrences</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">start</span><span class="p">,</span> <span class="n">delta</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">idx_dat</span><span class="p">)]</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">td</span>
            <span class="n">delta</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">td</span>
    <span class="k">return</span> <span class="n">occurrences</span></div>


<div class="viewcode-block" id="battery_gaps"><a class="viewcode-back" href="../../../api/niimpy.preprocess/#niimpy.preprocess.battery_gaps">[docs]</a><span class="k">def</span> <span class="nf">battery_gaps</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">min_duration_between</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Returns a DataFrame including all battery data and showing the delta between </span>
<span class="sd">    consecutive battery timestamps. The minimum size of the considered deltas can be decided </span>
<span class="sd">    with the min_duration_between parameter.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data: dataframe with date index</span>
<span class="sd">    min_duration_between: Timedelta, for example, pd.Timedelta(hours=6)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">),</span> <span class="s2">&quot;data is not a pandas DataFrame&quot;</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">indexes</span><span class="o">.</span><span class="n">datetimes</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">),</span> <span class="s2">&quot;data index is not DatetimeIndex&quot;</span>

    <span class="n">gaps</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">gaps</span><span class="p">[</span><span class="s1">&#39;tvalue&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gaps</span><span class="o">.</span><span class="n">index</span>
    <span class="n">gaps</span><span class="p">[</span><span class="s1">&#39;delta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">gaps</span><span class="p">[</span><span class="s1">&#39;tvalue&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">gaps</span><span class="p">[</span><span class="s1">&#39;tvalue&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">())</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
    <span class="k">if</span><span class="p">(</span><span class="n">min_duration_between</span><span class="o">!=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">gaps</span> <span class="o">=</span> <span class="n">gaps</span><span class="p">[</span><span class="n">gaps</span><span class="p">[</span><span class="s1">&#39;delta&#39;</span><span class="p">]</span><span class="o">&gt;=</span><span class="n">min_duration_between</span><span class="p">]</span>
    
    <span class="k">return</span> <span class="n">gaps</span></div>


<div class="viewcode-block" id="battery_charge_discharge"><a class="viewcode-back" href="../../../api/niimpy.preprocess/#niimpy.preprocess.battery_charge_discharge">[docs]</a><span class="k">def</span> <span class="nf">battery_charge_discharge</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Returns a DataFrame including all battery data and showing the charge/discharge between each timestamp.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data: dataframe with date index</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">),</span> <span class="s2">&quot;data is not a pandas DataFrame&quot;</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">indexes</span><span class="o">.</span><span class="n">datetimes</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">),</span> <span class="s2">&quot;data index is not DatetimeIndex&quot;</span>
    
    <span class="n">charge</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">charge</span><span class="p">[</span><span class="s1">&#39;battery_level&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">charge</span><span class="p">[</span><span class="s1">&#39;battery_level&#39;</span><span class="p">])</span>
    <span class="n">charge</span><span class="p">[</span><span class="s1">&#39;tvalue&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">charge</span><span class="o">.</span><span class="n">index</span>
    <span class="n">charge</span><span class="p">[</span><span class="s1">&#39;tdelta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">charge</span><span class="p">[</span><span class="s1">&#39;tvalue&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">charge</span><span class="p">[</span><span class="s1">&#39;tvalue&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">())</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>    
    <span class="n">charge</span><span class="p">[</span><span class="s1">&#39;bdelta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">charge</span><span class="p">[</span><span class="s1">&#39;battery_level&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">charge</span><span class="p">[</span><span class="s1">&#39;battery_level&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">())</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">charge</span><span class="p">[</span><span class="s1">&#39;charge/discharge&#39;</span><span class="p">]</span><span class="o">=</span> <span class="p">((</span><span class="n">charge</span><span class="p">[</span><span class="s1">&#39;bdelta&#39;</span><span class="p">])</span><span class="o">/</span><span class="p">((</span><span class="n">charge</span><span class="p">[</span><span class="s1">&#39;tdelta&#39;</span><span class="p">]</span><span class="o">/</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">1</span><span class="p">))))</span>
    
    <span class="k">return</span> <span class="n">charge</span></div>

<div class="viewcode-block" id="find_real_gaps"><a class="viewcode-back" href="../../../api/niimpy.preprocess/#niimpy.preprocess.find_real_gaps">[docs]</a><span class="k">def</span> <span class="nf">find_real_gaps</span><span class="p">(</span><span class="n">battery_data</span><span class="p">,</span><span class="n">other_data</span><span class="p">,</span><span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">days</span><span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">hours</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">minutes</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">seconds</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">milli</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">micro</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nano</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Returns a dataframe showing the gaps found both in the battery data and the other data.</span>
<span class="sd">        The default interval is 6 hours.</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        battery_data: Dataframe</span>
<span class="sd">        other_data: Dataframe</span>
<span class="sd">                    The data you want to compare with</span>
<span class="sd">        start: datetime, optional</span>
<span class="sd">        end: datetime, optional</span>
<span class="sd">        </span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">battery_data</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">),</span> <span class="s2">&quot;battery_data is not a pandas DataFrame&quot;</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other_data</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">),</span> <span class="s2">&quot;other_data is not a pandas DataFrame&quot;</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">battery_data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">indexes</span><span class="o">.</span><span class="n">datetimes</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">),</span> <span class="s2">&quot;battery_data index is not DatetimeIndex&quot;</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other_data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">indexes</span><span class="o">.</span><span class="n">datetimes</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">),</span> <span class="s2">&quot;other_data index is not DatetimeIndex&quot;</span>

    <span class="k">if</span><span class="p">(</span><span class="n">start</span><span class="o">!=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">battery_data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="n">battery_data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;=</span> <span class="n">other_data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">else</span> <span class="n">other_data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span><span class="p">(</span><span class="n">end</span><span class="o">!=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">end</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">battery_data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="n">battery_data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;=</span> <span class="n">other_data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="k">else</span> <span class="n">other_data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="n">battery</span> <span class="o">=</span> <span class="n">battery_occurrences</span><span class="p">(</span><span class="n">battery_data</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">,</span><span class="n">days</span><span class="o">=</span><span class="n">days</span><span class="p">,</span><span class="n">hours</span><span class="o">=</span><span class="n">hours</span><span class="p">,</span><span class="n">minutes</span><span class="o">=</span><span class="n">minutes</span><span class="p">,</span><span class="n">seconds</span><span class="o">=</span><span class="n">seconds</span><span class="p">,</span><span class="n">milli</span><span class="o">=</span><span class="n">milli</span><span class="p">,</span><span class="n">micro</span><span class="o">=</span><span class="n">micro</span><span class="p">,</span><span class="n">nano</span><span class="o">=</span><span class="n">nano</span><span class="p">)</span>
    <span class="n">battery</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;occurrences&#39;</span><span class="p">:</span> <span class="s1">&#39;battery_occurrences&#39;</span><span class="p">},</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">other</span> <span class="o">=</span> <span class="n">battery_occurrences</span><span class="p">(</span><span class="n">other_data</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span><span class="n">days</span><span class="o">=</span><span class="n">days</span><span class="p">,</span><span class="n">hours</span><span class="o">=</span><span class="n">hours</span><span class="p">,</span><span class="n">minutes</span><span class="o">=</span><span class="n">minutes</span><span class="p">,</span><span class="n">seconds</span><span class="o">=</span><span class="n">seconds</span><span class="p">,</span><span class="n">milli</span><span class="o">=</span><span class="n">milli</span><span class="p">,</span><span class="n">micro</span><span class="o">=</span><span class="n">micro</span><span class="p">,</span><span class="n">nano</span><span class="o">=</span><span class="n">nano</span><span class="p">)</span>
    
    <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">battery</span><span class="p">[</span><span class="s1">&#39;battery_occurrences&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">other</span><span class="p">[</span><span class="s1">&#39;occurrences&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">gaps</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">battery</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span><span class="n">other</span><span class="p">[</span><span class="n">mask</span><span class="p">][</span><span class="s1">&#39;occurrences&#39;</span><span class="p">]],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">gaps</span>  </div>

<div class="viewcode-block" id="find_non_battery_gaps"><a class="viewcode-back" href="../../../api/niimpy.preprocess/#niimpy.preprocess.find_non_battery_gaps">[docs]</a><span class="k">def</span> <span class="nf">find_non_battery_gaps</span><span class="p">(</span><span class="n">battery_data</span><span class="p">,</span><span class="n">other_data</span><span class="p">,</span><span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">days</span><span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">hours</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">minutes</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">seconds</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">milli</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">micro</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nano</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Returns a dataframe showing the gaps found only in the other data.</span>
<span class="sd">        The default interval is 6 hours.</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        battery_data: Dataframe</span>
<span class="sd">        other_data: Dataframe</span>
<span class="sd">                    The data you want to compare with</span>
<span class="sd">        start: datetime, optional</span>
<span class="sd">        end: datetime, optional</span>
<span class="sd">        </span>
<span class="sd">    &quot;&quot;&quot;</span> 
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">battery_data</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">),</span> <span class="s2">&quot;battery_data is not a pandas DataFrame&quot;</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other_data</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">),</span> <span class="s2">&quot;other_data is not a pandas DataFrame&quot;</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">battery_data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">indexes</span><span class="o">.</span><span class="n">datetimes</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">),</span> <span class="s2">&quot;battery_data index is not DatetimeIndex&quot;</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other_data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">indexes</span><span class="o">.</span><span class="n">datetimes</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">),</span> <span class="s2">&quot;other_data index is not DatetimeIndex&quot;</span>

    <span class="k">if</span><span class="p">(</span><span class="n">start</span><span class="o">!=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">battery_data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="n">battery_data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;=</span> <span class="n">other_data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">else</span> <span class="n">other_data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span><span class="p">(</span><span class="n">end</span><span class="o">!=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">end</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">battery_data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="n">battery_data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;=</span> <span class="n">other_data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="k">else</span> <span class="n">other_data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="n">battery</span> <span class="o">=</span> <span class="n">battery_occurrences</span><span class="p">(</span><span class="n">battery_data</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">,</span><span class="n">days</span><span class="o">=</span><span class="n">days</span><span class="p">,</span><span class="n">hours</span><span class="o">=</span><span class="n">hours</span><span class="p">,</span><span class="n">minutes</span><span class="o">=</span><span class="n">minutes</span><span class="p">,</span><span class="n">seconds</span><span class="o">=</span><span class="n">seconds</span><span class="p">,</span><span class="n">milli</span><span class="o">=</span><span class="n">milli</span><span class="p">,</span><span class="n">micro</span><span class="o">=</span><span class="n">micro</span><span class="p">,</span><span class="n">nano</span><span class="o">=</span><span class="n">nano</span><span class="p">)</span>
    <span class="n">battery</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;occurrences&#39;</span><span class="p">:</span> <span class="s1">&#39;battery_occurrences&#39;</span><span class="p">},</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>    
    <span class="n">other</span> <span class="o">=</span> <span class="n">battery_occurrences</span><span class="p">(</span><span class="n">other_data</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span><span class="n">days</span><span class="o">=</span><span class="n">days</span><span class="p">,</span><span class="n">hours</span><span class="o">=</span><span class="n">hours</span><span class="p">,</span><span class="n">minutes</span><span class="o">=</span><span class="n">minutes</span><span class="p">,</span><span class="n">seconds</span><span class="o">=</span><span class="n">seconds</span><span class="p">,</span><span class="n">milli</span><span class="o">=</span><span class="n">milli</span><span class="p">,</span><span class="n">micro</span><span class="o">=</span><span class="n">micro</span><span class="p">,</span><span class="n">nano</span><span class="o">=</span><span class="n">nano</span><span class="p">)</span>    
    <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">battery</span><span class="p">[</span><span class="s1">&#39;battery_occurrences&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">10</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">other</span><span class="p">[</span><span class="s1">&#39;occurrences&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">gaps</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">battery</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span><span class="n">other</span><span class="p">[</span><span class="n">mask</span><span class="p">][</span><span class="s1">&#39;occurrences&#39;</span><span class="p">]],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">gaps</span></div>

<div class="viewcode-block" id="find_battery_gaps"><a class="viewcode-back" href="../../../api/niimpy.preprocess/#niimpy.preprocess.find_battery_gaps">[docs]</a><span class="k">def</span> <span class="nf">find_battery_gaps</span><span class="p">(</span><span class="n">battery_data</span><span class="p">,</span><span class="n">other_data</span><span class="p">,</span><span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">days</span><span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">hours</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">minutes</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">seconds</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">milli</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">micro</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nano</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Returns a dataframe showing the gaps found only in the battery data.</span>
<span class="sd">        The default interval is 6 hours.</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        battery_data: Dataframe</span>
<span class="sd">        other_data: Dataframe</span>
<span class="sd">                    The data you want to compare with</span>
<span class="sd">        start: datetime, optional</span>
<span class="sd">        end: datetime, optional</span>
<span class="sd">        </span>
<span class="sd">    &quot;&quot;&quot;</span> 
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">battery_data</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">),</span> <span class="s2">&quot;battery_data is not a pandas DataFrame&quot;</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other_data</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">),</span> <span class="s2">&quot;other_data is not a pandas DataFrame&quot;</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">battery_data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">indexes</span><span class="o">.</span><span class="n">datetimes</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">),</span> <span class="s2">&quot;battery_data index is not DatetimeIndex&quot;</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other_data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">indexes</span><span class="o">.</span><span class="n">datetimes</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">),</span> <span class="s2">&quot;other_data index is not DatetimeIndex&quot;</span>

    <span class="k">if</span><span class="p">(</span><span class="n">start</span><span class="o">!=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">battery_data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="n">battery_data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;=</span> <span class="n">other_data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">else</span> <span class="n">other_data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span><span class="p">(</span><span class="n">end</span><span class="o">!=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">end</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">battery_data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="n">battery_data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;=</span> <span class="n">other_data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="k">else</span> <span class="n">other_data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="n">battery</span> <span class="o">=</span> <span class="n">battery_occurrences</span><span class="p">(</span><span class="n">battery_data</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">,</span><span class="n">days</span><span class="o">=</span><span class="n">days</span><span class="p">,</span><span class="n">hours</span><span class="o">=</span><span class="n">hours</span><span class="p">,</span><span class="n">minutes</span><span class="o">=</span><span class="n">minutes</span><span class="p">,</span><span class="n">seconds</span><span class="o">=</span><span class="n">seconds</span><span class="p">,</span><span class="n">milli</span><span class="o">=</span><span class="n">milli</span><span class="p">,</span><span class="n">micro</span><span class="o">=</span><span class="n">micro</span><span class="p">,</span><span class="n">nano</span><span class="o">=</span><span class="n">nano</span><span class="p">)</span>
    <span class="n">battery</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;occurrences&#39;</span><span class="p">:</span> <span class="s1">&#39;battery_occurrences&#39;</span><span class="p">},</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">other</span> <span class="o">=</span> <span class="n">battery_occurrences</span><span class="p">(</span><span class="n">other_data</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">,</span><span class="n">days</span><span class="o">=</span><span class="n">days</span><span class="p">,</span><span class="n">hours</span><span class="o">=</span><span class="n">hours</span><span class="p">,</span><span class="n">minutes</span><span class="o">=</span><span class="n">minutes</span><span class="p">,</span><span class="n">seconds</span><span class="o">=</span><span class="n">seconds</span><span class="p">,</span><span class="n">milli</span><span class="o">=</span><span class="n">milli</span><span class="p">,</span><span class="n">micro</span><span class="o">=</span><span class="n">micro</span><span class="p">,</span><span class="n">nano</span><span class="o">=</span><span class="n">nano</span><span class="p">)</span>    
    <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">battery</span><span class="p">[</span><span class="s1">&#39;battery_occurrences&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">other</span><span class="p">[</span><span class="s1">&#39;occurrences&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">gaps</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">battery</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span><span class="n">other</span><span class="p">[</span><span class="n">mask</span><span class="p">][</span><span class="s1">&#39;occurrences&#39;</span><span class="p">]],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">gaps</span> </div>

<div class="viewcode-block" id="missing_data_format"><a class="viewcode-back" href="../../../api/niimpy.preprocess/#niimpy.preprocess.missing_data_format">[docs]</a><span class="k">def</span> <span class="nf">missing_data_format</span><span class="p">(</span><span class="n">question</span><span class="p">,</span><span class="n">keep_values</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Returns a series of timestamps in the right format to allow missing data visualization</span>
<span class="sd">    .</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        question: Dataframe</span>
<span class="sd">        </span>
<span class="sd">    &quot;&quot;&quot;</span> 
    <span class="n">question</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">question</span><span class="o">.</span><span class="n">index</span>
    <span class="n">question</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">question</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span> <span class="k">lambda</span> <span class="n">question</span> <span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="n">question</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="n">question</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="n">question</span><span class="o">.</span><span class="n">day</span><span class="p">))</span>
    <span class="n">question</span> <span class="o">=</span> <span class="n">question</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">],</span><span class="n">keep</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">)</span>

    <span class="n">question</span> <span class="o">=</span>  <span class="n">question</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;date&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">keep_values</span> <span class="o">==</span> <span class="kc">False</span><span class="p">):</span>
        <span class="n">question</span><span class="p">[</span><span class="s1">&#39;answer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">question</span> <span class="o">=</span> <span class="n">question</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">question</span></div>

<div class="viewcode-block" id="screen_missing_data"><a class="viewcode-back" href="../../../api/niimpy.preprocess/#niimpy.preprocess.screen_missing_data">[docs]</a><span class="k">def</span> <span class="nf">screen_missing_data</span><span class="p">(</span><span class="n">database</span><span class="p">,</span><span class="n">subject</span><span class="p">,</span><span class="n">begin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Returns a DataFrame contanining the percentage (range [0,1]) of loss data</span>
<span class="sd">    calculated based on the transitions of screen status. In general, if</span>
<span class="sd">    screen_status(t) == screen_status(t+1), we declared we have at least one</span>
<span class="sd">    missing point. </span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">    --------</span>
<span class="sd">    database: Niimpy database</span>
<span class="sd">    user: string</span>
<span class="sd">    begin: datetime, optional</span>
<span class="sd">    end: datetime, optional</span>

<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    count: Dataframe</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">niimpy</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">Data1</span><span class="p">),</span><span class="s2">&quot;database not given in Niimpy database format&quot;</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subject</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span><span class="s2">&quot;usr not given in string format&quot;</span>
    
    <span class="n">screen</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">table</span><span class="o">=</span><span class="s1">&#39;AwareScreen&#39;</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">subject</span><span class="p">)</span>
    
    <span class="k">if</span><span class="p">(</span><span class="n">begin</span><span class="o">!=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">begin</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">),</span><span class="s2">&quot;begin not given in timestamp format&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">begin</span> <span class="o">=</span> <span class="n">screen</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span>
    <span class="k">if</span><span class="p">(</span><span class="n">end</span><span class="o">!=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">end</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">),</span><span class="s2">&quot;end not given in timestamp format&quot;</span>  
    <span class="k">else</span><span class="p">:</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">screen</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">screen</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span>  
        
    <span class="n">screen</span><span class="o">=</span><span class="n">screen</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">],</span><span class="n">keep</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">)</span>
    <span class="n">screen</span> <span class="o">=</span> <span class="n">screen</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;device&#39;</span><span class="p">,</span><span class="s1">&#39;user&#39;</span><span class="p">,</span><span class="s1">&#39;time&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">screen</span><span class="o">=</span><span class="n">screen</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">begin</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>
    <span class="n">screen</span><span class="p">[</span><span class="s1">&#39;screen_status&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">screen</span><span class="p">[</span><span class="s1">&#39;screen_status&#39;</span><span class="p">])</span>
    
    <span class="c1">#Include the missing points that are due to shutting down the phone</span>
    <span class="n">shutdown</span> <span class="o">=</span> <span class="n">shutdown_info</span><span class="p">(</span><span class="n">database</span><span class="p">,</span><span class="n">subject</span><span class="p">,</span><span class="n">begin</span><span class="p">,</span><span class="n">end</span><span class="p">)</span>
    <span class="n">shutdown</span><span class="o">=</span><span class="n">shutdown</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;battery_status&#39;</span><span class="p">:</span><span class="s1">&#39;screen_status&#39;</span><span class="p">})</span>
    <span class="n">shutdown</span><span class="p">[</span><span class="s1">&#39;screen_status&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">screen</span> <span class="o">=</span> <span class="n">screen</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">shutdown</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">screen</span><span class="p">[</span><span class="s1">&#39;screen_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">screen</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="s1">&#39;screen_status_x&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">screen</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="s1">&#39;screen_status_y&#39;</span><span class="p">]</span>
    <span class="n">screen</span> <span class="o">=</span> <span class="n">screen</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;screen_status_x&#39;</span><span class="p">,</span><span class="s1">&#39;screen_status_y&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">dates</span><span class="o">=</span><span class="n">screen</span><span class="o">.</span><span class="n">datetime_x</span><span class="o">.</span><span class="n">combine_first</span><span class="p">(</span><span class="n">screen</span><span class="o">.</span><span class="n">datetime_y</span><span class="p">)</span>
    <span class="n">screen</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">dates</span>
    <span class="n">screen</span> <span class="o">=</span> <span class="n">screen</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;datetime_x&#39;</span><span class="p">,</span><span class="s1">&#39;datetime_y&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="c1">#Detect missing data points</span>
    <span class="n">screen</span><span class="p">[</span><span class="s1">&#39;missing&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">screen</span><span class="p">[</span><span class="s1">&#39;next&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">screen</span><span class="p">[</span><span class="s1">&#39;screen_status&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">screen</span><span class="p">[</span><span class="s1">&#39;dummy&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">screen</span><span class="p">[</span><span class="s1">&#39;screen_status&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">screen</span><span class="p">[</span><span class="s1">&#39;next&#39;</span><span class="p">]</span>
    <span class="n">screen</span><span class="p">[</span><span class="s1">&#39;missing&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">screen</span><span class="p">[</span><span class="s1">&#39;dummy&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">screen</span><span class="p">[</span><span class="s1">&#39;missing&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">screen</span><span class="p">[</span><span class="s1">&#39;missing&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">screen</span> <span class="o">=</span> <span class="n">screen</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;dummy&#39;</span><span class="p">,</span><span class="s1">&#39;next&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">screen</span> <span class="o">=</span> <span class="n">screen</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="n">screen</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">screen</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span> <span class="k">lambda</span> <span class="n">screen</span> <span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="n">screen</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="n">screen</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="n">screen</span><span class="o">.</span><span class="n">day</span><span class="p">))</span>
    <span class="n">screen</span> <span class="o">=</span> <span class="n">screen</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;screen_status&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">count</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="n">screen</span><span class="p">,</span><span class="n">values</span><span class="o">=</span><span class="s1">&#39;missing&#39;</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;datetime&#39;</span><span class="p">,</span> <span class="n">aggfunc</span><span class="o">=</span><span class="s1">&#39;count&#39;</span><span class="p">)</span>
    <span class="n">count</span> <span class="o">=</span> <span class="n">screen</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;datetime&#39;</span><span class="p">,</span><span class="s1">&#39;missing&#39;</span><span class="p">])[</span><span class="s1">&#39;missing&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">count</span><span class="p">[</span><span class="s1">&#39;missing&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">count</span><span class="p">[</span><span class="mf">1.0</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">count</span><span class="p">[</span><span class="mf">0.0</span><span class="p">]</span><span class="o">+</span><span class="n">count</span><span class="p">[</span><span class="mf">1.0</span><span class="p">])</span>
    <span class="n">count</span> <span class="o">=</span> <span class="n">count</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">1.0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">tzname</span><span class="p">(</span><span class="n">count</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span> <span class="s1">&#39;EET&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">tzname</span><span class="p">(</span><span class="n">count</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span> <span class="s1">&#39;EEST&#39;</span><span class="p">:</span>
            <span class="n">count</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">count</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="s1">&#39;Europe/Helsinki&#39;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">count</span></div>

<div class="viewcode-block" id="missing_noise"><a class="viewcode-back" href="../../../api/niimpy.preprocess/#niimpy.preprocess.missing_noise">[docs]</a><span class="k">def</span> <span class="nf">missing_noise</span><span class="p">(</span><span class="n">database</span><span class="p">,</span><span class="n">subject</span><span class="p">,</span><span class="n">begin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Returns a Dataframe with the estimated missing data from the ambient </span>
<span class="sd">    noise sensor. </span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    NOTE: This function aggregates data by day. </span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">    --------</span>
<span class="sd">    database: Niimpy database</span>
<span class="sd">    user: string</span>
<span class="sd">    begin: datetime, optional</span>
<span class="sd">    end: datetime, optional</span>

<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    avg_noise: Dataframe</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">niimpy</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">Data1</span><span class="p">),</span><span class="s2">&quot;database not given in Niimpy database format&quot;</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subject</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span><span class="s2">&quot;user not given in string format&quot;</span>
    
    <span class="n">noise</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">table</span><span class="o">=</span><span class="s1">&#39;AwareAmbientNoise&#39;</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">subject</span><span class="p">)</span>
    
    <span class="k">if</span><span class="p">(</span><span class="n">begin</span><span class="o">!=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">begin</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">),</span><span class="s2">&quot;begin not given in timestamp format&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">begin</span> <span class="o">=</span> <span class="n">noise</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span>
    <span class="k">if</span><span class="p">(</span><span class="n">end</span><span class="o">!=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">end</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">),</span><span class="s2">&quot;end not given in timestamp format&quot;</span>  
    <span class="k">else</span><span class="p">:</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">noise</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">noise</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span>
    
    <span class="n">noise</span> <span class="o">=</span> <span class="n">noise</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;device&#39;</span><span class="p">,</span><span class="s1">&#39;user&#39;</span><span class="p">,</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;double_silence_threshold&#39;</span><span class="p">,</span><span class="s1">&#39;double_rms&#39;</span><span class="p">,</span><span class="s1">&#39;blob_raw&#39;</span><span class="p">,</span><span class="s1">&#39;is_silent&#39;</span><span class="p">,</span><span class="s1">&#39;double_frequency&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">noise</span> <span class="o">=</span> <span class="n">noise</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">begin</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>
    <span class="n">noise</span><span class="p">[</span><span class="s1">&#39;duration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">noise</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
    <span class="n">noise</span><span class="p">[</span><span class="s1">&#39;duration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_seconds</span><span class="p">(</span><span class="n">noise</span><span class="p">[</span><span class="s1">&#39;duration&#39;</span><span class="p">])</span>
    <span class="n">noise</span> <span class="o">=</span> <span class="n">noise</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="n">shutdown</span> <span class="o">=</span> <span class="n">shutdown_info</span><span class="p">(</span><span class="n">database</span><span class="p">,</span><span class="n">subject</span><span class="p">,</span><span class="n">begin</span><span class="p">,</span><span class="n">end</span><span class="p">)</span>
    <span class="n">shutdown</span><span class="o">=</span><span class="n">shutdown</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;battery_status&#39;</span><span class="p">:</span><span class="s1">&#39;duration&#39;</span><span class="p">})</span>
    <span class="n">noise</span> <span class="o">=</span> <span class="n">noise</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">shutdown</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">noise</span><span class="p">[</span><span class="s1">&#39;duration_x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">noise</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="s1">&#39;duration_x&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">noise</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="s1">&#39;duration_y&#39;</span><span class="p">]</span>
    <span class="n">noise</span><span class="o">=</span><span class="n">noise</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;duration_x&#39;</span><span class="p">:</span><span class="s1">&#39;duration&#39;</span><span class="p">})</span> 
    <span class="n">dates</span><span class="o">=</span><span class="n">noise</span><span class="o">.</span><span class="n">datetime_x</span><span class="o">.</span><span class="n">combine_first</span><span class="p">(</span><span class="n">noise</span><span class="o">.</span><span class="n">datetime_y</span><span class="p">)</span>
    <span class="n">noise</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">dates</span>
    <span class="n">noise</span> <span class="o">=</span> <span class="n">noise</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;datetime_x&#39;</span><span class="p">,</span><span class="s1">&#39;datetime_y&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">noise</span><span class="o">=</span><span class="n">noise</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;double_decibels&#39;</span><span class="p">,</span> <span class="s1">&#39;duration_y&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">noise</span><span class="p">[</span><span class="s1">&#39;missing&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">noise</span><span class="p">[</span><span class="s1">&#39;duration&#39;</span><span class="p">]</span><span class="o">&gt;=</span><span class="mi">1860</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1">#detect the missing points </span>
    <span class="n">noise</span><span class="p">[</span><span class="s1">&#39;dummy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">noise</span><span class="o">.</span><span class="n">missing</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="c1">#assumes that everytime the cellphone shuts down, two timestamps are generated with -1 in the battery_health</span>
    <span class="n">noise</span><span class="p">[</span><span class="s1">&#39;dummy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">noise</span><span class="o">.</span><span class="n">dummy</span><span class="o">*</span><span class="n">noise</span><span class="o">.</span><span class="n">duration</span>
    <span class="n">noise</span><span class="p">[</span><span class="s1">&#39;dummy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">noise</span><span class="o">.</span><span class="n">dummy</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">noise</span><span class="p">[</span><span class="s1">&#39;missing&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">noise</span><span class="p">[</span><span class="s1">&#39;missing&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">noise</span><span class="p">[</span><span class="s1">&#39;duration&#39;</span><span class="p">]</span><span class="o">/</span><span class="mi">1800</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span> <span class="c1">#calculate the number of datapoints missing</span>
    <span class="n">noise</span> <span class="o">=</span> <span class="n">noise</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">noise</span><span class="p">[</span><span class="n">noise</span><span class="o">.</span><span class="n">dummy</span><span class="o">==-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> <span class="c1">#delete those missing datapoints due to the phone being shut down</span>
    <span class="n">noise</span> <span class="o">=</span> <span class="n">noise</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;duration&#39;</span><span class="p">,</span> <span class="s1">&#39;datetime&#39;</span><span class="p">,</span> <span class="s1">&#39;dummy&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">noise</span></div>
    
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2020, the contributors.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>